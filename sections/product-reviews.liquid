{% comment %}
  Product Reviews Section - Clean Version

  Modular reviews section that can be placed anywhere in product templates
  Features:
  - Reviews statistics and list
  - Review form drawer
  - Fully self-contained JavaScript
  - Works with any product context
{% endcomment %}

<div id="product-reviews" class="product-reviews-section py-12 lg:px-12 px-4 lg:py-16 bg-white">
  <div class="reviews-container">
    <!-- Reviews Statistics (Liquid-rendered from metafield) -->
    {% assign reviews = product.metafields.custom.ratings.value %}

    {% if reviews and reviews.count > 0 %}
      {% assign total_reviews = reviews.count %}
      {% assign sum_ratings = 0 %}
      {% for r in reviews %}
        {% assign r_rating = r.rating | default: 0 | plus: 0 %}
        {% assign sum_ratings = sum_ratings | plus: r_rating %}
      {% endfor %}
      {% assign average_rating = sum_ratings | divided_by: total_reviews %}

      {%- comment -%}
        Compute average fit rating across reviews that include `fit_rating` (1-5)
      {%- endcomment -%}
      {% assign sum_fit = 0 %}
      {% assign count_fit = 0 %}
      {% for r in reviews %}
        {% if r.fit_rating %}
          {% assign sum_fit = sum_fit | plus: r.fit_rating %}
          {% assign count_fit = count_fit | plus: 1 %}
        {% endif %}
      {% endfor %}
      {% if count_fit > 0 %}
        {% assign average_fit_float = sum_fit | times: 1.0 | divided_by: count_fit %}
        {% assign average_fit = average_fit_float %}
        {% assign fit_avg_position = average_fit | minus: 1 | times: 25 %}
      {% endif %}

      <!-- Reviews Stats -->
      <div id="reviews-stats-{{ product.id }}" class="reviews-stats mb-8">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-end">
          <!-- Left side: Rating and breakdown -->
          <div class="space-y-6 lg:col-span-2">
            <!-- Main rating display -->
            <div class="flex gap-2  text-center lg:text-left  items-center ">
              <div class="text-[18px] font-semibold ">{{ average_rating | round: 1 }}</div>

              {% render 'star-rating',
                rating: average_rating,
                size: 'lg',
                color: 'text-[#f3a000]',
                show_count: false,
                show_review_count: false,
                show_rating_value: false
              %}
              <span class="body-sm">
                Basado en {{ total_reviews }} opinión{% unless total_reviews == 1 %}es{% endunless %}
              </span>
            </div>

            <!-- Rating breakdown -->
            <div class="space-y-1 rating-breakdown lg:col-span-2">
              {% for i in (1..5) %}
                {% assign current_rating = 6 | minus: i %}
                {% assign star_count = 0 %}
                {% for r in reviews %}
                  {% if r.rating == current_rating %}
                    {% assign star_count = star_count | plus: 1 %}
                  {% endif %}
                {% endfor %}
                {% assign percentage = star_count | times: 100 | divided_by: total_reviews %}
                <div class="flex items-center gap-2 rating-bar-item" data-delay="{{ i | minus: 1 | times: 200 }}">
                  <div class="flex items-center gap-2">
                    <span class="text-yellow-400 text-sm">★</span>
                    <span class="text-sm font-medium text-gray-700">{{ current_rating }}</span>
                  </div>
                  <div class="flex-1 bg-gray-200 rounded-full h-1">
                    <div
                      class="rating-bar-fill bg-black h-1 rounded-full"
                      style="width: 0%; --target-width: {{ percentage }}%;"
                      data-target-width="{{ percentage }}%"
                    ></div>
                  </div>
                  <span class="text-sm text-gray-600 text-right">{{ star_count }}</span>
                </div>
              {% endfor %}
            </div>
          </div>

          {%- if count_fit > 0 -%}
            <!-- Middle: Average Fit Bar -->
            <div class="lg:col-span-2">
              <div class="fit-average">
                <div class="relative">
                  <!-- Track -->
                  <div class="relative w-full max-w-sm h-1 bg-gray-300 rounded-full">
                    <!-- 5 position dots -->
                    <div class="absolute inset-0 flex items-center justify-between">
                      <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                      <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                      <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                      <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                      <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                    </div>

                    <!-- Marker based on average -->
                    <div
                      class="absolute top-1/2 transform -translate-y-1/2 w-2.5 h-2.5 bg-gray-800 rounded-full"
                      style="left: calc({{ fit_avg_position }}% - 8px);"
                      aria-label="Average fit rating"
                    ></div>
                  </div>

                  <!-- Labels and value -->
                  <div class="flex justify-between mt-3 text-xs text-gray-600 max-w-sm">
                    <span>Muy pequeño</span>
                    <span class="text-center">Tamaño real</span>
                    <span>Muy grande</span>
                  </div>
                </div>
              </div>
            </div>
          {%- endif -%}

          <!-- Review Form Toggle Button -->
          {% if section.settings.show_review_form %}
            <div class="review-form-toggle lg:col-span-1">
              <button
                class="body-lg font-semibold py-4 bg-primary border border-primary text-white hover:bg-transparent hover:border-black hover:text-black transition-colors duration-300  w-full"
                id="write-review-btn-{{ product.id }}"
              >
                {{ section.settings.write_review_text | default: 'Write a Review' }}
              </button>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Reviews List -->
      <div id="reviews-list-{{ product.id }}" class="reviews-list mb-8">
        {% for review in reviews %}
          <div class="">
            <div class="review-layout grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
              <!-- Left Column: Reviewer Info (3 cols) -->
              <div class="reviewer-info lg:col-span-3">
                <div class="space-y-2.5">
                  <!-- Reviewer name -->
                  <div class="flex flex-wrap gap-2 items-end">
                    <div class="body font-semibold ">{{ review.author_name }}</div>
                    <!-- Verified buyer badge -->
                    {% if review.is_verified_buyer %}
                      <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-green-600 rounded-full flex items-center justify-center">
                          {% render 'check-icon', class: 'size-2.5 stroke-2 text-white' %}
                        </div>
                        <span class="body-sm">Verified Buyer</span>
                      </div>
                    {% endif %}
                  </div>

                  <!-- Reviewer details -->
                  <div class="space-y-2 text-sm">
                    <div class="space-y-2 text-sm">
                      {% if review.age_range %}
                        <div class="flex items-center gap-2">
                          <span class="text-gray-500 font-medium">Rango de edad:</span>
                          <div class="text-gray-900">{{ review.age_range }}</div>
                        </div>
                      {% endif %}

                      {% if review.size_purchased %}
                        <div class="flex items-center gap-2">
                          <span class="text-gray-500 font-medium">Tamaño adquirido:</span>
                          <div class="text-gray-900">{{ review.size_purchased }}</div>
                        </div>
                      {% endif %}

                      {% if review.shipping_rating %}
                        <div class="flex items-center gap-2">
                          <span class="text-gray-500 font-medium">Calificación de envío:</span>
                          <div class="flex items-center gap-1">
                            {% comment %}si el shipping rating es 1 -> renderizar un texto que dice muy malo, 2 -> malo, 3 -> regular, 4 -> bueno, 5 -> muy bueno {% endcomment %}
                            <span class="text-gray-600 text-xs ml-1">
                              {% if review.shipping_rating == 1 %}
                                Muy malo
                              {% elsif review.shipping_rating == 2 %}
                                Malo
                              {% elsif review.shipping_rating == 3 %}
                                Regular
                              {% elsif review.shipping_rating == 4 %}
                                Bueno
                              {% elsif review.shipping_rating == 5 %}
                                Excelente
                              {% endif %}
                            </span>
                            <span class="text-gray-600 text-xs ml-1">({{ review.shipping_rating }}/5)</span>
                          </div>
                        </div>
                      {% endif %}

                      {% if review.recommends_product != null %}
                        <div class="flex items-center gap-2">
                          <span class="text-gray-500 font-medium">Recomienda el producto:</span>
                          <div class="flex items-center gap-1">
                            {% if review.recommends_product %}
                              <span class="text-green-600 text-sm">✓</span>
                              <span class="text-green-600 text-sm font-medium">Si</span>
                            {% else %}
                              <span class="text-red-500 text-sm">✗</span>
                              <span class="text-red-500 text-sm font-medium">No</span>
                            {% endif %}
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Middle Column: Review Content (6 cols) -->
              <div class="review-content lg:col-span-6">
                <div class="space-y-2">
                  <!-- Star rating -->
                  {% render 'star-rating',
                    rating: review.rating,
                    size: 'md',
                    color: 'text-[#f3a000]',
                    show_count: false,
                    show_review_count: false,
                    show_rating_value: false
                  %}
                  {% if review.title %}
                    <h5>{{ review.title }}</h5>
                  {% endif %}

                  {% if review.body %}
                    <p class="text-gray-700 text-base leading-relaxed">{{ review.body }}</p>
                  {% endif %}

                  <!-- Fit evaluation bar -->
                  {% if review.fit_rating %}
                    <div class="fit-evaluation">
                      <div class="relative">
                        <!-- Fit slider track -->
                        <div class="relative w-full max-w-sm h-1 bg-gray-300 rounded-full">
                          <!-- Position dots (5 positions for scale 1-5) -->
                          <div class="absolute inset-0 flex items-center justify-between">
                            <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                            <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                            <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                            <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                            <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                          </div>

                          <!-- Active marker - Fixed positioning for 1-5 scale -->
                          {% assign fit_position = review.fit_rating | minus: 1 | times: 25 %}
                          <div
                            class="absolute top-1/2 transform -translate-y-1/2 w-2.5 h-2.5 bg-gray-800 rounded-full"
                            style="left: calc({{ fit_position }}% - 8px);"
                          ></div>
                        </div>

                        <!-- Labels -->
                        <div class="flex justify-between mt-3 text-xs text-gray-600 max-w-sm">
                          <span>Muy pequeño</span>
                          <span class="text-center">Tamaño real</span>
                          <span>Muy grande</span>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Right Column: Media & Timestamp (3 cols) -->
              <div class="review-media lg:col-span-3">
                <div class="flex flex-col items-end gap-4">
                  <!-- Timestamp -->
                  {% if review.created_at %}
                    <span class="text-sm text-gray-500 text-right">
                      {{ review.created_at | date: '%B %d, %Y' }}
                    </span>
                  {% endif %}

                  <!-- Media carousel -->
                  {% if review.image or review.video %}
                    <div class="review-media-carousel relative w-32 h-40">
                      <div class="swiper review-swiper-{{ forloop.index }}">
                        <div class="swiper-wrapper">
                          {% if review.image %}
                            <div class="swiper-slide">
                              <div class="w-full h-full bg-gray-100  overflow-hidden">
                                <img
                                  src="{{ review.image | image_url: width: 300 }}"
                                  alt="Review image"
                                  class="w-full h-full object-cover"
                                  width="128"
                                  height="160"
                                  loading="lazy"
                                >
                              </div>
                            </div>
                          {% endif %}

                          {% if review.video %}
                            <div class="swiper-slide">
                              <div class="w-full h-full bg-gray-100  overflow-hidden">
                                {% if review.video.sources %}
                                  <video
                                    controls
                                    class="w-full h-full object-cover"
                                    muted
                                    loop
                                    playsinline
                                    preload="metadata"
                                  >
                                    {% for source in review.video.sources %}
                                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                                    {% endfor %}
                                    Your browser does not support the video tag.
                                  </video>
                                {% elsif review.video.value and review.video.value.sources %}
                                  <video
                                    controls
                                    class="w-full h-full object-cover"
                                    muted
                                    loop
                                    playsinline
                                    preload="metadata"
                                  >
                                    {% for source in review.video.value.sources %}
                                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                                    {% endfor %}
                                    Your browser does not support the video tag.
                                  </video>
                                {% elsif review.video contains 'gid://shopify/Video/' %}
                                  <video
                                    controls
                                    class="w-full h-full object-cover"
                                    muted
                                    loop
                                    playsinline
                                    preload="metadata"
                                  >
                                    <source src="{{ review.video | file_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                  </video>
                                {% elsif review.video contains '.mp4' %}
                                  <video
                                    controls
                                    class="w-full h-full object-cover"
                                    muted
                                    loop
                                    playsinline
                                    preload="metadata"
                                  >
                                    <source src="{{ review.video }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                  </video>
                                {% else %}
                                  <div class="w-full h-full flex items-center justify-center bg-gray-800 ">
                                    <a
                                      href="{{ review.video }}"
                                      target="_blank"
                                      rel="noopener"
                                      class="text-white text-center p-2"
                                    >
                                      <div class="text-2xl mb-1">▶️</div>
                                      <div class="text-xs">Ver video</div>
                                    </a>
                                  </div>
                                {% endif %}
                              </div>
                            </div>
                          {% endif %}
                        </div>

                        <!-- Navigation arrows -->
                        {% if review.image and review.video %}
                          <div class="swiper-button-next review-next-{{ forloop.index }}"></div>
                          <div class="swiper-button-prev review-prev-{{ forloop.index }}"></div>
                        {% endif %}
                      </div>
                    </div>
                  {% else %}
                    <div class="w-32 h-40 bg-gray-100  flex items-center justify-center">
                      <span class="text-gray-400 text-xs text-center">Sin medios</span>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div id="reviews-stats-{{ product.id }}" class="reviews-stats mb-8">
        <p class="text-gray-500 text-center py-4">No reviews yet</p>
      </div>
      <div id="reviews-list-{{ product.id }}" class="reviews-list mb-8">
        <p class="text-gray-500 text-center py-4">No reviews found</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Simple initialization
  (function() {
    const productId = {{ product.id }};

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeReviews);
    } else {
      initializeReviews();
    }

    function initializeReviews() {
       // Initialize Swiper carousels for reviews with multiple media
       if (typeof Swiper !== 'undefined') {
         setTimeout(() => {
           const reviewSwipers = document.querySelectorAll('[class*="review-swiper-"]');
           reviewSwipers.forEach((swiperElement, index) => {
             if (!swiperElement.swiper) {
               const swiperIndex = swiperElement.className.match(/review-swiper-(\d+)/)[1];
               new Swiper(swiperElement, {
                 direction: 'horizontal',
                 slidesPerView: 1,
                 spaceBetween: 0,
                 loop: false,
                 navigation: {
                   nextEl: `.review-next-${swiperIndex}`,
                   prevEl: `.review-prev-${swiperIndex}`,
                 },
               });
             }
           });
         }, 200);
       }

       // Initialize rating bar animations
       initializeRatingBars();
       
       // Initialize video elements
       initializeVideos();
     }

     function initializeRatingBars() {
       const ratingBars = document.querySelectorAll('.rating-bar-fill');

       // Reset all bars to 0 width
       ratingBars.forEach(bar => {
         bar.style.width = '0%';
       });

       // Animate bars sequentially using data attribute fallback
       ratingBars.forEach((bar, index) => {
         const delay = index * 200; // 200ms delay between each bar

         setTimeout(() => {
           // Prefer CSS custom property; fallback to data attribute
           let targetWidth = bar.style.getPropertyValue('--target-width');
           if (!targetWidth || targetWidth === '0%') {
             targetWidth = bar.getAttribute('data-target-width');
           }
           if (targetWidth && targetWidth !== '0%') {
             bar.style.width = targetWidth;
           }
         }, delay);
       });
     }

     function initializeVideos() {
       const videos = document.querySelectorAll('.review-media-carousel video');
       
       videos.forEach(video => {
         // Ensure video is muted for autoplay compliance
         video.muted = true;
         video.playsInline = true;

         // Check if HLS.js is available and needed
         const videoSrc = video.querySelector('source')?.src;
         if (videoSrc && videoSrc.includes('.m3u8')) {
           if (typeof Hls !== 'undefined' && Hls.isSupported()) {
             const hls = new Hls();
             hls.loadSource(videoSrc);
             hls.attachMedia(video);
             hls.on(Hls.Events.MANIFEST_PARSED, () => {
               console.log('HLS manifest parsed for review video');
             });
           } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
             video.src = videoSrc;
           }
         }

         video.addEventListener('error', (e) => {
           console.error('Review video loading error:', e);
         });

         video.addEventListener('loadedmetadata', () => {
           console.log('Review video metadata loaded');
         });
       });
     }
  })();
</script>

<style>
  /* Review Card Styles */
  .review-card {
    transition: all 0.2s ease;
  }

  .review-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* Rating Bar Animation Styles */
  .rating-bar-fill {
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: left;
  }

  .rating-bar-item {
    opacity: 0;
    animation: fadeInUp 0.6s ease forwards;
  }

  .rating-bar-item:nth-child(1) {
    animation-delay: 0ms;
  }
  .rating-bar-item:nth-child(2) {
    animation-delay: 200ms;
  }
  .rating-bar-item:nth-child(3) {
    animation-delay: 400ms;
  }
  .rating-bar-item:nth-child(4) {
    animation-delay: 600ms;
  }
  .rating-bar-item:nth-child(5) {
    animation-delay: 800ms;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Review Layout Grid */
  .review-layout {
    align-items: flex-start;
  }

  /* Reviewer Info Column */
  .reviewer-info {
    position: sticky;
    top: 20px;
  }

  /* Review Media Column */
  .review-media {
    position: sticky;
    top: 20px;
  }

  /* Fit Evaluation Styles */
  .fit-evaluation {
    padding: 16px 0;
  }

  /* Enhanced Fit Slider for 5-position scale */
  .fit-evaluation .relative {
    max-width: 320px;
  }

  .fit-evaluation .w-3 {
    width: 12px;
    height: 12px;
  }

  .fit-evaluation .w-4 {
    width: 16px;
    height: 16px;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  /* Review Media Carousel Styles */
  .review-media-carousel {
    position: relative;
    width: 128px;
    height: 160px;
  }

  .review-media-carousel .swiper {
    width: 100%;
    height: 100%;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .review-media-carousel .swiper-slide {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .review-media-carousel .swiper-button-next,
  .review-media-carousel .swiper-button-prev {
    color: #374151;
    background: rgba(255, 255, 255, 0.9);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: all 0.2s ease;
  }

  .review-media-carousel .swiper-button-next:hover,
  .review-media-carousel .swiper-button-prev:hover {
    background: rgba(255, 255, 255, 1);
    transform: scale(1.1);
  }

  .review-media-carousel .swiper-button-next:after,
  .review-media-carousel .swiper-button-prev:after {
    font-size: 10px;
    font-weight: bold;
  }

  .review-media-carousel .swiper-button-next {
    right: 4px;
  }

  .review-media-carousel .swiper-button-prev {
    left: 4px;
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .review-layout {
      grid-template-columns: 1fr !important;
      gap: 1rem;
    }

    .reviewer-info,
    .review-media {
      position: static;
    }

    .review-media {
      order: -1;
      align-items: center;
    }

    .review-media-carousel {
      width: 120px;
      height: 150px;
    }

    .fit-evaluation .relative {
      max-width: 280px;
    }
  }

  @media (max-width: 640px) {
    .review-card {
      padding: 1rem;
    }

    .review-media-carousel {
      width: 100px;
      height: 130px;
    }
  }
</style>

{% schema %}
{
  "name": "Product Reviews",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Review Form Settings"
    },
    {
      "type": "checkbox",
      "id": "show_review_form",
      "label": "Show Review Form",
      "default": true,
      "info": "Enable/disable the review form functionality"
    },
    {
      "type": "text",
      "id": "write_review_text",
      "label": "Write Review Button Text",
      "default": "Write a Review",
      "info": "Text for the write review button"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
