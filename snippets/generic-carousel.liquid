{% comment %}
  Generic Reusable Carousel Snippet

  Parameters:
  - carousel_id: Unique ID for the carousel
  - carousel_class: Additional CSS classes
  - content: The content to be rendered inside swiper-wrapper
  - show_arrows: Whether to show navigation arrows (default: true, hidden on mobile)
  - slides_per_view_mobile: Mobile slides per view (default: 1.35)
  - slides_per_view_desktop: Desktop slides per view (default: 4)
  - space_between_mobile: Mobile space between slides (default: 2)
  - space_between_desktop: Desktop space between slides (default: 4)
  - centered_slides: Whether to center slides (default: true for mobile, false for desktop)
  - free_mode: Whether to enable free mode (default: true)
  - total_items: Total number of items (for arrow state management)
{% endcomment %}

{% assign carousel_id = carousel_id | default: 'carousel' %}
{% assign carousel_class = carousel_class | default: '' %}
{% assign show_arrows = show_arrows | default: true %}
{% assign slides_per_view_mobile = slides_per_view_mobile | default: 1.35 %}
{% assign slides_per_view_desktop = slides_per_view_desktop | default: 4 %}
{% assign space_between_mobile = space_between_mobile | default: 2 %}
{% assign space_between_desktop = space_between_desktop | default: 4 %}
{% assign centered_slides = centered_slides | default: true %}
{% assign free_mode = free_mode | default: true %}
{% assign total_items = total_items | default: 0 %}

<div class="relative overflow-hidden">
  <div
    class="  px-4 lg:px-12 swiper-{{ carousel_id }} {{ carousel_class }}"
    data-carousel-id="{{ carousel_id }}"
    data-carousel-type="generic-carousel"
  >
    <div class="  swiper-wrapper">
      {{ content }}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const carouselElement = document.querySelector('.swiper-{{ carousel_id }}');

    if (carouselElement && typeof Swiper !== 'undefined') {
      // Check if this carousel is already initialized
      if (carouselElement.swiper) {
        return;
      }

      const totalItems = {{ total_items }};
      const enableDesktopCarousel = totalItems > {{ slides_per_view_desktop }};

      const swiper = new Swiper(carouselElement, {
        slidesPerView: {{ slides_per_view_mobile }},
        spaceBetween: {{ space_between_mobile }},
        {% if centered_slides %}
        centeredSlides: true,
        centeredSlidesBounds: true,
        {% endif %}
        {% if free_mode %}
        freeMode: {
          enabled: true,
          sticky: true,
          momentum: true,
          momentumRatio: 0.25,
          momentumVelocityRatio: 0.5,
          momentumBounce: true,
          momentumBounceRatio: 0.3,
        },
        {% endif %}
        grabCursor: false,
        breakpoints: {
          1024: {
            slidesPerView: {{ slides_per_view_desktop }},
            spaceBetween: {{ space_between_desktop }},
            centeredSlides: false,
            {% if show_arrows %}
            navigation: {
              nextEl: '.product-carousel-next, .look-fit-carousel-next, .carousel-next',
              prevEl: '.product-carousel-prev, .look-fit-carousel-prev, .carousel-prev',
            },
            {% endif %}
            {% if free_mode %}
            freeMode: {
              enabled: true,
              sticky: true,
              momentum: true,
            },
            {% endif %}
          }
        },
        {% if show_arrows %}
        on: {
          init: function() {
            updateGenericArrowStates(this, '{{ carousel_id }}');
          },
          afterInit: function() {
            updateGenericArrowStates(this, '{{ carousel_id }}');
          },
          slideChange: function() {
            updateGenericArrowStates(this, '{{ carousel_id }}');
          },
          activeIndexChange: function() {
            updateGenericArrowStates(this, '{{ carousel_id }}');
          },
          reachBeginning: function() {
            updateGenericArrowStates(this, '{{ carousel_id }}');
          },
          reachEnd: function() {
            updateGenericArrowStates(this, '{{ carousel_id }}');
          },
          fromEdge: function() {
            updateGenericArrowStates(this, '{{ carousel_id }}');
          },
          slideChangeTransitionEnd: function() {
            updateGenericArrowStates(this, '{{ carousel_id }}');
          },
          transitionEnd: function() {
            updateGenericArrowStates(this, '{{ carousel_id }}');
          },
        },
        {% endif %}
      });

      // Store the swiper instance on the element to avoid conflicts
      carouselElement.swiper = swiper;
    }

    {% if show_arrows %}
    // Function to update arrow states for carousel (desktop only)
    function updateGenericArrowStates(swiper, carouselId) {
      // Only update arrows on desktop (1024px and above)
      if (window.innerWidth < 1024) {
        return;
      }

      // Try to find carousel specific arrows in order of priority
      let prevArrow = document.querySelector(`.product-carousel-prev[data-carousel-id="${carouselId}"]`) ||
                      document.querySelector(`.look-fit-carousel-prev[data-carousel-id="${carouselId}"]`);
      let nextArrow = document.querySelector(`.product-carousel-next[data-carousel-id="${carouselId}"]`) ||
                      document.querySelector(`.look-fit-carousel-next[data-carousel-id="${carouselId}"]`);
      
      // Fallback to generic arrows if specific arrows not found
      if (!prevArrow || !nextArrow) {
        const sectionContainer = document.querySelector(`[data-carousel-id="${carouselId}"]`).closest('section, div');
        if (sectionContainer) {
          prevArrow = prevArrow || sectionContainer.querySelector('.carousel-prev');
          nextArrow = nextArrow || sectionContainer.querySelector('.carousel-next');
        }
      }

      console.log('Carousel', carouselId, '- isBeginning:', swiper.isBeginning, 'isEnd:', swiper.isEnd, 'activeIndex:', swiper.activeIndex, 'slides:', swiper.slides.length);

      if (prevArrow) {
        if (swiper.isBeginning) {
          // At the beginning - disable left arrow (gray state)
          prevArrow.disabled = true;
          prevArrow.classList.remove('bg-primary', 'text-white', 'cursor-pointer');
          prevArrow.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
          // Remove hover effects when disabled
          prevArrow.style.pointerEvents = 'none';
        } else {
          // Not at beginning - enable left arrow (blue state)
          prevArrow.disabled = false;
          prevArrow.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
          prevArrow.classList.add('bg-primary', 'text-white', 'cursor-pointer');
          // Re-enable hover effects when enabled
          prevArrow.style.pointerEvents = 'auto';
        }
      }

      if (nextArrow) {
        if (swiper.isEnd) {
          // At the end - disable right arrow (gray state)
          nextArrow.disabled = true;
          nextArrow.classList.remove('bg-primary', 'text-white', 'cursor-pointer');
          nextArrow.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
          // Remove hover effects when disabled
          nextArrow.style.pointerEvents = 'none';
        } else {
          // Not at end - enable right arrow (blue state)
          nextArrow.disabled = false;
          nextArrow.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
          nextArrow.classList.add('bg-primary', 'text-white', 'cursor-pointer');
          // Re-enable hover effects when enabled
          nextArrow.style.pointerEvents = 'auto';
        }
      }
    }

    // Ensure arrows are properly initialized with a longer delay
    setTimeout(() => {
      const carouselElement = document.querySelector('.swiper-{{ carousel_id }}');
      if (carouselElement && carouselElement.swiper) {
        updateGenericArrowStates(carouselElement.swiper, '{{ carousel_id }}');
      }
    }, 200);
    {% endif %}
  });
</script>
