{% comment %}
  Complementary Products Snippet - Renders metafield linked products

  Usage:
  {% render 'complementary-products',
    block: block,
    current_product: product
  %}

  Parameters:
  - block: Block object with settings
  - current_product: Current product object
{% endcomment %}

{% assign section_title = block.settings.title | default: 'COMPLETA EL ATUENDO:' %}
{% assign metafield_key = block.settings.metafield_key | default: 'complementary_products' %}

{% comment %} Get complementary products from metafield {% endcomment %}
{% assign complementary_products = current_product.metafields.custom[metafield_key].value %}

{% comment %} Only render if we have complementary products {% endcomment %}
{% if complementary_products and complementary_products.size > 0 %}
  <div class="complementary-products-section py-16 px-4 md:px-8">
    <div class="max-w-4xl mx-auto">
      <!-- Section Title -->
      {% if section_title != blank %}
        <h2 class="text-xl font-bold text-gray-900 mb-8 text-center md:text-left">
          {{ section_title }}
        </h2>
      {% endif %}

      <!-- Products List -->
      <div class="complementary-products-list space-y-6">
        {% for complementary_product in complementary_products %}
          <div class="complementary-product-item bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-300">
            <div class="flex flex-col md:flex-row">
              <!-- Product Image -->
              <div class="w-full md:w-24 h-48 md:h-24 flex-shrink-0">
                {% if complementary_product.featured_image %}
                  <img
                    src="{{ complementary_product.featured_image | image_url: width: 200 }}"
                    alt="{{ complementary_product.title }}"
                    class="w-full h-full object-cover"
                    loading="lazy"
                  >
                {% else %}
                  <div class="w-full h-full bg-gray-100 flex items-center justify-center">
                    <span class="text-gray-400 text-sm">No image</span>
                  </div>
                {% endif %}
              </div>

              <!-- Product Info -->
              <div class="flex-1 p-4 md:p-3 flex flex-col md:flex-row md:items-center md:justify-between">
                <!-- Product Details -->
                <div class="flex-1 mb-4 md:mb-0">
                  <h3 class="font-semibold text-gray-900 text-base mb-2">
                    {{ complementary_product.title }}
                  </h3>

                  <!-- Price -->
                  <div class="flex items-center gap-2">
                    <span class="text-lg font-bold text-gray-900">
                      ${{ complementary_product.price | money_without_currency }}
                    </span>
                    {% if complementary_product.compare_at_price > complementary_product.price %}
                      <span class="text-sm text-gray-500 line-through">
                        ${{ complementary_product.compare_at_price | money_without_currency }}
                      </span>
                    {% endif %}
                  </div>
                </div>

                <!-- Color Swatches -->
                {% for option in complementary_product.options_with_values %}
                  {% if option.name == 'Color' %}
                    <div class="flex items-center gap-2 mb-4 md:mb-0 md:mx-4">
                      {% for option_value in option.values limit: 4 %}
                        <div
                          class="w-6 h-6 rounded-full border border-gray-300"
                          {% if option_value.swatch.color %}
                            style="background-color: {{ option_value.swatch.color }};"
                          {% elsif option_value.swatch.image %}
                            style="background-image: url({{ option_value.swatch.image | image_url: width: 50 }}); background-size: cover; background-position: center;"
                          {% else %}
                            style="background-color: #e5e7eb;"
                          {% endif %}
                          title="{{ option_value }}"
                        ></div>
                      {% endfor %}
                      {% if option.values.size > 4 %}
                        <span class="text-xs text-gray-500">+{{ option.values.size | minus: 4 }}</span>
                      {% endif %}
                    </div>
                    {% break %}
                  {% endif %}
                {% endfor %}

                <!-- Size Options -->
                {% for option in complementary_product.options_with_values %}
                  {% if option.name == 'Talla' or option.name == 'Size' %}
                    <div class="flex items-center gap-1 mb-4 md:mb-0 md:mx-4">
                      {% for option_value in option.values limit: 6 %}
                        <span class="px-2 py-1 text-xs border border-gray-300 rounded text-gray-700">
                          {{ option_value }}
                        </span>
                      {% endfor %}
                      {% if option.values.size > 6 %}
                        <span class="text-xs text-gray-500">+{{ option.values.size | minus: 6 }}</span>
                      {% endif %}
                    </div>
                    {% break %}
                  {% endif %}
                {% endfor %}

                <!-- Quantity Selector -->
                <div class="flex items-center gap-3 mb-4 md:mb-0">
                  <div class="flex items-center border border-gray-300 rounded-lg">
                    <button
                      class="px-3 py-2 text-gray-600 hover:text-gray-800 focus:outline-none"
                      onclick="decreaseQuantity('{{ complementary_product.id }}')"
                    >
                      −
                    </button>
                    <input
                      type="number"
                      id="quantity-{{ complementary_product.id }}"
                      value="1"
                      min="1"
                      max="10"
                      class="w-12 text-center border-0 focus:outline-none focus:ring-0"
                    >
                    <button
                      class="px-3 py-2 text-gray-600 hover:text-gray-800 focus:outline-none"
                      onclick="increaseQuantity('{{ complementary_product.id }}')"
                    >
                      +
                    </button>
                  </div>
                </div>

                <!-- Add to Cart Button -->
                <div class="md:ml-4">
                  <button
                    onclick="addComplementaryToCart({{ complementary_product.selected_or_first_available_variant.id }}, '{{ complementary_product.id }}')"
                    class="w-full md:w-auto px-6 py-3 bg-black text-white font-medium rounded-lg hover:bg-gray-800 transition-colors duration-200"
                  >
                    Añadir al carrito
                  </button>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}

<script>
  function increaseQuantity(productId) {
    const input = document.getElementById(`quantity-${productId}`);
    const currentValue = parseInt(input.value);
    const maxValue = parseInt(input.max);
    if (currentValue < maxValue) {
      input.value = currentValue + 1;
    }
  }

  function decreaseQuantity(productId) {
    const input = document.getElementById(`quantity-${productId}`);
    const currentValue = parseInt(input.value);
    const minValue = parseInt(input.min);
    if (currentValue > minValue) {
      input.value = currentValue - 1;
    }
  }

  async function addComplementaryToCart(variantId, productId) {
    try {
      const quantity = parseInt(document.getElementById(`quantity-${productId}`).value);

      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          items: [
            {
              id: variantId,
              quantity: quantity,
            },
          ],
        }),
      });

      if (response.ok) {
        // Trigger cart update event
        if (window.Alpine) {
          window.Alpine.store('cart').updateCart();
        }

        // Show success message
        showSuccessMessage('¡Producto añadido al carrito!');
      }
    } catch (error) {
      console.error('Error adding to cart:', error);
      showSuccessMessage('Error al añadir el producto');
    }
  }

  function showSuccessMessage(message) {
    // Create a temporary success message
    const messageEl = document.createElement('div');
    messageEl.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    messageEl.textContent = message;
    document.body.appendChild(messageEl);

    // Remove after 2 seconds
    setTimeout(() => {
      if (document.body.contains(messageEl)) {
        document.body.removeChild(messageEl);
      }
    }, 2000);
  }
</script>

<style>
  .complementary-product-item:hover {
    transform: translateY(-1px);
  }

  /* Hide number input spinners */
  input[type='number']::-webkit-outer-spin-button,
  input[type='number']::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  input[type='number'] {
    -moz-appearance: textfield;
  }
</style>
