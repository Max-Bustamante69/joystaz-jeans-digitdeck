{% comment %}
  Product Card Snippet
  Features:
  - Product image with color variant switching
  - Product badges (New, Best Seller)
  - Wishlist heart icon
  - Star rating
  - Product name and price
  - Color swatches with image switching
  - Size selection grid that appears on plus icon click
  - Add to cart functionality
{% endcomment %}

<div class="product-card relative group w-full flex flex-col h-full max-w-full" x-data="productCard{{ product.id }}()">
  <!-- Product Image Container -->
  <div class="relative overflow-hidden aspect-[3/4] bg-gray-100 mb-4 w-full group/image flex-shrink-0 max-w-full">
    <!-- Product Image Carousel -->
    {% if product.images.size > 1 %}
      <div
        class="product-image-carousel swiper-product-images-{{ product.id }}-{{ section.id }} w-full h-full pointer-events-none"
        data-product-id="{{ product.id }}"
        data-section-id="{{ section.id }}"
        data-carousel-type="product-images"
        id="product-images-carousel-{{ product.id }}-{{ section.id }}"
      >
        <div class="swiper-wrapper h-full">
          {% for image in product.images %}
            <div class="swiper-slide w-full h-full flex-shrink-0">
              <img
                src="{{ image | image_url: width: 600 }}"
                alt="{{ product.title }} - Image {{ forloop.index }}"
                class="w-full h-full object-cover"
                width="600"
                height="600"
                loading="eager"
              >
            </div>
          {% endfor %}
        </div>

        <!-- Navigation Arrows -->
        <div class="absolute inset-0 pointer-events-none group-hover:block">
          <button
            class="product-prev absolute border p-2 border-white/50 left-2 top-1/2 -translate-y-1/2 w-10 h-10 md:w-10 md:h-10 bg-white/10 md:bg-white/5 backdrop-blur-sm flex items-center justify-center opacity-100 md:opacity-0 group-hover:opacity-100 transition-all duration-300 hover:bg-white/20 z-50 pointer-events-auto cursor-pointer touch-manipulation"
            data-carousel-id="product-images-carousel-{{ product.id }}-{{ section.id }}"
            type="button"
          >
            <svg
              class="w-5 h-5 md:w-5 md:h-5 text-white drop-shadow-md"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              stroke-width="2.5"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          <button
            class="product-next absolute border p-2 border-white/50 right-2 top-1/2 -translate-y-1/2 w-10 h-10 md:w-10 md:h-10 bg-white/10 md:bg-white/5 backdrop-blur-sm flex items-center justify-center opacity-100 md:opacity-0 group-hover:opacity-100 transition-all duration-300 hover:bg-white/20 z-50 pointer-events-auto cursor-pointer touch-manipulation"
            data-carousel-id="product-images-carousel-{{ product.id }}-{{ section.id }}"
            type="button"
          >
            <svg
              class="w-5 h-5 md:w-5 md:h-5 text-white drop-shadow-md"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              stroke-width="2.5"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>
    {% else %}
      <!-- Single Image -->
      <img
        src="{{ product.featured_image | image_url: width: 400 }}"
        alt="{{ product.title }}"
        class="w-full h-full object-cover"
        width="400"
        height="400"
        loading="eager"
      >
    {% endif %}

    <!-- Product Badges -->
    {% if show_badges and product.tags.size > 0 %}
      <div class="absolute top-2 left-2 flex flex-col gap-1 z-30">
        {% for tag in product.tags %}
          {% assign tag_lower = tag | downcase %}
          {% if tag_lower contains 'nuevo' %}
            <span class="bg-white text-black text-xs px-2 py-1 font-bold">{{ tag | upcase }}</span>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <!-- Product Link Overlay (for clicking to go to product page) - positioned behind interactive elements -->
    <a
      href="{{ product.url }}"
      class="absolute inset-0 z-10 pointer-events-auto"
      aria-label="View {{ product.title }}"
    ></a>

    <!-- Size Selector Grid - Only show if "Talla" is in product options -->
    {% if product.options contains 'Talla' %}
      <div
        x-show="showSizeSelector"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-4"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-4"
        @click.outside="showSizeSelector = false"
        class="absolute bottom-0 left-0 right-0 bg-white border border-gray-200 shadow-lg  z-30"
      >
        <div class="grid grid-cols-5 gap-1">
          {% comment %} Get all unique sizes and check their availability for selected color {% endcomment %}
          {% assign unique_sizes = '' %}
          {% assign size_data = '' %}

          {% comment %} First pass: collect all unique sizes {% endcomment %}
          {% for variant in product.variants %}
            {% assign size_name = '' %}
            {% for option in variant.options %}
              {% assign is_size = true %}
              {% for product_option in product.options_with_values %}
                {% if product_option.name == 'Color' %}
                  {% for color_value in product_option.values %}
                    {% if option == color_value %}
                      {% assign is_size = false %}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
              {% if is_size %}
                {% assign size_name = option %}
                {% break %}
              {% endif %}
            {% endfor %}

            {% unless unique_sizes contains size_name %}
              {% assign unique_sizes = unique_sizes | append: size_name | append: ',' %}
            {% endunless %}
          {% endfor %}

          {% comment %} Second pass: render size buttons with availability check {% endcomment %}
          {% assign sizes_array = unique_sizes | split: ',' %}
          {% for size_name in sizes_array %}
            {% if size_name != blank %}
              {% comment %} Find variant that matches current selected color and this size {% endcomment %}
              {% assign size_available = false %}
              {% assign matching_variant_id = null %}

              {% for variant in product.variants %}
                {% assign variant_color = '' %}
                {% assign variant_size = '' %}

                {% comment %} Extract color and size from variant options {% endcomment %}
                {% for option in variant.options %}
                  {% assign is_color = false %}
                  {% for product_option in product.options_with_values %}
                    {% if product_option.name == 'Color' %}
                      {% for color_value in product_option.values %}
                        {% if option == color_value %}
                          {% assign variant_color = option %}
                          {% assign is_color = true %}
                          {% break %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}

                  {% unless is_color %}
                    {% assign variant_size = option %}
                  {% endunless %}
                {% endfor %}

                {% comment %} Check if this variant matches current size {% endcomment %}
                {% if variant_size == size_name %}
                  {% comment %} For now, check if variant is available - color matching will be handled by Alpine.js {% endcomment %}
                  {% if variant.available %}
                    {% assign size_available = true %}
                    {% assign matching_variant_id = variant.id %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              <button
                class="relative px-6 py-4 text-md text-center font-semibold transition-colors overflow-hidden"
                x-bind:class="isSizeAvailable('{{ size_name }}') ? 'hover:bg-gray-100 text-gray-900' : 'text-gray-400 cursor-not-allowed'"
                @click="handleSizeClick('{{ size_name }}')"
                x-bind:disabled="!isSizeAvailable('{{ size_name }}')"
              >
                {{ size_name }}
                {% comment %} Diagonal line for sold out sizes {% endcomment %}
                <div
                  x-show="!isSizeAvailable('{{ size_name }}')"
                  class="absolute inset-0 pointer-events-none"
                >
                  <div class="absolute top-0 left-0 w-full h-full">
                    <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                      <line x1="0" y1="0" x2="100" y2="100"
                            stroke="currentColor"
                            stroke-width="2"
                            class="text-gray-400"/>
                    </svg>
                  </div>
                </div>
              </button>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Product Information -->
  <div class="space-y-2 p-1 w-full flex-1 flex flex-col justify-start">
    <!-- Star Rating and Plus Icon -->
    <div class="flex items-center justify-between">
      {% if show_rating %}
        <div class="flex items-center gap-1">
          <div class="flex text-yellow-400">
            {% assign rating = product.metafields.reviews.rating.value | default: 3.5 %}
            {% assign full_stars = rating | floor %}
            {% assign next_star = full_stars | plus: 1 %}
            {% for i in (1..5) %}
              {% if i <= full_stars %}
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              {% elsif i == next_star and rating > full_stars %}
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <defs>
                    <linearGradient id="half-star-{{ product.id }}-{{ i }}">
                      <stop offset="50%" stop-color="currentColor"/>
                      <stop offset="50%" stop-color="#e5e7eb"/>
                    </linearGradient>
                  </defs>
                  <path fill="url(#half-star-{{ product.id }}-{{ i }})" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              {% else %}
                <svg class="w-4 h-4" fill="#e5e7eb" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              {% endif %}
            {% endfor %}
          </div>
          <span class="text-sm text-gray-500">({{ product.metafields.reviews.rating.value | default: 0 }})</span>
        </div>
      {% else %}
        <div></div>
        <!-- Empty div for spacing when no rating -->
      {% endif %}

      {% if show_size_selector %}
        <button
          class="text-gray-600 hover:text-gray-800 transition-colors relative z-30"
          @click="handlePlusClick"
          type="button"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
        </button>
      {% endif %}
    </div>

    <!-- Product Name and Price -->
    <div class="flex items-start justify-between space-y-2">
      <!-- Product Title Section -->
      <div class="flex flex-col items-start justify-start space-y-1">
        <h3 class="font-semibold text-gray-900 text-sm leading-tight">{{ product.title }}</h3>

        <!-- Color Circles - Using product.options_with_values for proper swatch access -->
        <!-- Pattern: product_option.name == "Color" then product_option_value.swatch.color -->
        {% for product_option in product.options_with_values %}
          {% if product_option.name == 'Color' %}
            <div class="flex items-center gap-2 mt-2">
              {% for product_option_value in product_option.values %}
                {% comment %} Find a variant with this color to get its image {% endcomment %}
                {% assign color_variant = null %}
                {% for variant in product.variants %}
                  {% for option in variant.options %}
                    {% if option == product_option_value %}
                      {% assign color_variant = variant %}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                  {% if color_variant %}
                    {% break %}
                  {% endif %}
                {% endfor %}

                <button
                  @click="selectColor('{{ product_option_value }}', '{{ color_variant.featured_image | image_url: width: 600 }}', {{ color_variant.id }})"
                  class="w-4 h-4 rounded-full border-1 transition-colors"
                  :class="selectedColor === '{{ product_option_value }}' ? 'ring-1 ring-offset-2 border-transparent ring-black' : 'border-gray-300 hover:border-gray-400'"
                  {% if product_option_value.swatch.color %}
                    style="background-color: {{ product_option_value.swatch.color }};"
                  {% else %}
                    style="background-image: url({{ product_option_value.swatch.image | image_url: width: 600 }}); background-size: cover; background-position: center;"
                  {% endif %}
                  title="{{ product_option_value }}"
                ></button>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Price Section -->
      <div class="flex flex-col items-start space-y-1">
        <span class="font-bold text-gray-900 text-sm">${{ product.price | money_without_currency }}</span>
        {% if product.compare_at_price > product.price %}
          <span class="text-xs text-gray-500 line-through">
            ${{ product.compare_at_price | money_without_currency }}
          </span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  function productCard{{ product.id }}() {
    return {
      productId: {{ product.id }},
      {% comment %}Find the first color option dynamically{% endcomment %}
      {% assign first_color = '' %}
      {% assign first_color_variant = null %}
      {% for product_option in product.options_with_values %}
        {% for product_option_value in product_option.values %}
          {% if product_option_value.swatch %}
            {% assign first_color = product_option_value %}
            {% comment %}Find a variant with this color{% endcomment %}
            {% for variant in product.variants %}
              {% for option in variant.options %}
                {% if option == first_color %}
                  {% assign first_color_variant = variant %}
                  {% break %}
                {% endif %}
              {% endfor %}
              {% if first_color_variant %}{% break %}{% endif %}
            {% endfor %}
            {% break %}
          {% endif %}
        {% endfor %}
        {% if first_color != '' %}{% break %}{% endif %}
      {% endfor %}
      
      selectedVariantId: {{ first_color_variant.id | default: product.selected_or_first_available_variant.id }},
      selectedVariantImage: null,
      selectedColor: '{{ first_color | default: product.selected_or_first_available_variant.option1 }}',
      selectedSize: null,
      showSizeSelector: false,
      isInWishlist: false,

      selectColor(color, imageUrl, variantId) {
        this.selectedColor = color;
        this.selectedVariantId = variantId;

        // Debug stock levels when color changes
        console.log(`Color changed to: ${color}`);
        this.debugStockLevels();

        // Update the product image if a new image URL is provided
        if (imageUrl && imageUrl !== '') {
          this.selectedVariantImage = imageUrl;

          // Update the carousel if it exists
          const carouselElement = this.$el.querySelector('.product-image-carousel');
          if (carouselElement && carouselElement.swiper) {
            // Find the slide with the matching image and go to it
            const slides = carouselElement.querySelectorAll('.swiper-slide img');
            slides.forEach((slide, index) => {
              if (slide.src === imageUrl) {
                carouselElement.swiper.slideTo(index);
                return;
              }
            });
          }
        }
      },

      // === CORE DATA METHODS ===
      
      getVariants() {
        return [
          {% for variant in product.variants %}
            {
              id: {{ variant.id }},
              options: [{% for option in variant.options %}'{{ option }}'{% unless forloop.last %}, {% endunless %}{% endfor %}],
              available: {{ variant.available | json }},
              inventory_quantity: {{ variant.inventory_quantity | default: 0 }},
              inventory_policy: '{{ variant.inventory_policy | default: "deny" }}'
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ];
      },

      getFirstColorWithSwatch() {
        const productOptions = [
          {% for product_option in product.options_with_values %}
            {
              values: [
                {% for product_option_value in product_option.values %}
                  { value: '{{ product_option_value }}', hasSwatch: {{ product_option_value.swatch | json }} }{% unless forloop.last %},{% endunless %}
                {% endfor %}
              ]
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ];

        for (const option of productOptions) {
          for (const value of option.values) {
            if (value.hasSwatch) return value.value;
          }
        }
        return null;
      },

      hasColorVariants() {
        return !!this.getFirstColorWithSwatch();
      },

      // === VARIANT MATCHING ABSTRACTION ===
      
      findVariant(size, colorRequired = true) {
        const variants = this.getVariants();
        const hasColors = this.hasColorVariants();
        
        return variants.find(variant => {
          const matchesSize = variant.options.includes(size);
          const matchesColor = !hasColors || !colorRequired || variant.options.includes(this.selectedColor);
          return matchesSize && matchesColor;
        });
      },

      findAvailableVariant(size) {
        const variant = this.findVariant(size, true);
        return variant && variant.available ? variant : null;
      },

      // === SIMPLIFIED PUBLIC METHODS ===
      
      isSizeAvailable(size) {
        return !!this.findAvailableVariant(size);
      },

      getSizeStock(size) {
        const variant = this.findVariant(size, true);
        
        if (!variant) {
          return { available: false, stock: 0, policy: 'deny', variantId: null };
        }

        return {
          available: variant.available,
          stock: variant.inventory_quantity,
          policy: variant.inventory_policy,
          variantId: variant.id
        };
      },

      // === UTILITY METHODS ===
      
      getAllSizes() {
        const variants = this.getVariants();
        const allOptions = variants.map(v => v.options).flat();
        
        if (!this.hasColorVariants()) {
          return [...new Set(allOptions)];
        }
        
        // Filter out colors to get only sizes
        return [...new Set(allOptions.filter(option => option !== this.selectedColor))];
      },

      debugStockLevels() {
        const hasColors = this.hasColorVariants();
        const title = hasColors 
          ? `=== Stock Debug for Product ${this.productId} - Color: ${this.selectedColor} ===`
          : `=== Stock Debug for Product ${this.productId} - No Color Variants ===`;
        
        console.log(title);
        
        this.getAllSizes().forEach(size => {
          const stockInfo = this.getSizeStock(size);
          console.log(`Size ${size}:`, stockInfo);
        });
        
        console.log('=== End Stock Debug ===');
      },

      handleSizeClick(size) {
        if (!this.isSizeAvailable(size)) return;
        
        const variant = this.findAvailableVariant(size);
        if (variant) {
          this.selectSize(size, variant.id);
        }
      },

      handlePlusClick() {
        // Debug stock levels when opening size selector
        this.debugStockLevels();
        
        // Check if product has Talla option using the product data
        const productOptions = {{ product.options | json }};
        const hasTalla = productOptions.includes('Talla');
        const hasColor = productOptions.includes('Color');

        if (hasTalla) {
          // If product has sizes, open size selector
          this.toggleSizeSelector();
        } else {
          // If no sizes, add to cart directly
          this.addToCart(this.selectedVariantId);
        }
      },

      toggleSizeSelector() {
        this.showSizeSelector = !this.showSizeSelector;
      },

      selectSize(size, variantId) {
        this.selectedSize = size;
        this.selectedVariantId = variantId;

        // Check if product has Color option using the product data
        const productOptions = {{ product.options | json }};
        const hasColor = productOptions.includes('Color');

        if (hasColor) {
          // If product has colors, we need to find the variant with current color and selected size
          const currentColor = this.selectedColor;
          // Find the variant that matches both size and color
          const targetVariantId = this.findVariantBySizeAndColor(size, currentColor);
          if (targetVariantId) {
            this.addToCart(targetVariantId);
          } else {
            this.addToCart(variantId);
          }
        } else {
          // If no colors, just add the selected variant
          this.addToCart(variantId);
        }

        this.showSizeSelector = false;
      },



      async addToCart(variantId) {
        try {
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              items: [{
                id: variantId,
                quantity: 1
              }]
            })
          });

                    if (response.ok) {
            // Trigger cart update event
            this.$dispatch('cart:updated');

            // Open cart drawer
            this.$dispatch('cart:open');

            // Show success feedback
            this.showSuccessMessage();
          }
        } catch (error) {
          console.error('Error adding to cart:', error);
        }
      },

      showSuccessMessage() {
        // Create a temporary success message
        const message = document.createElement('div');
        message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        message.textContent = 'Added to cart!';
        document.body.appendChild(message);

        // Remove after 2 seconds
        setTimeout(() => {
          document.body.removeChild(message);
        }, 2000);
      },

      findVariantByColor(color) {
        // Get all variants from the product with their options
        const variants = [
          {% for variant in product.variants %}
            {
              id: {{ variant.id }},
              options: [{% for option in variant.options %}'{{ option }}'{% unless forloop.last %}, {% endunless %}{% endfor %}]
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ];

        // Find variant that matches the color
        const targetVariant = variants.find(variant =>
          variant.options.includes(color)
        );

        return targetVariant ? targetVariant.id : null;
      },

      findVariantBySizeAndColor(size, color) {
        // Get all variants from the product with their options
        const variants = [
          {% for variant in product.variants %}
            {
              id: {{ variant.id }},
              options: [{% for option in variant.options %}'{{ option }}'{% unless forloop.last %}, {% endunless %}{% endfor %}]
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ];

        // Find variant that matches both size and color
        const targetVariant = variants.find(variant =>
          variant.options.includes(size) && variant.options.includes(color)
        );

        return targetVariant ? targetVariant.id : null;
      },

      toggleWishlist() {
        this.isInWishlist = !this.isInWishlist;
        // Here you would typically make an API call to add/remove from wishlist
      },

      // === INITIALIZATION ===
      
      init() {
        this.initializeColorSelection();
        this.debugStockLevels();
        this.initializeCarousel();
      },

      initializeColorSelection() {
        if (!this.hasColorVariants()) {
          console.log(`Initializing Product Card ${this.productId} - No Color Variants`);
          return;
        }
        
        const firstColor = this.getFirstColorWithSwatch();
        if (firstColor && firstColor !== this.selectedColor) {
          console.log(`Correcting selected color from ${this.selectedColor} to ${firstColor}`);
          this.selectedColor = firstColor;
        }
        console.log(`Initializing Product Card ${this.productId} - Selected Color: ${this.selectedColor}`);
      },

      initializeCarousel() {
        
        this.$nextTick(() => {
          const carouselElement = this.$el.querySelector('.product-image-carousel');
          if (carouselElement && typeof Swiper !== 'undefined') {
            const carouselId = carouselElement.id;

            // Check if this carousel is already initialized
            if (carouselElement.swiper) {
              return;
            }

            // Create swiper instance
            const swiperInstance = new Swiper(carouselElement, {
              slidesPerView: 1,
              spaceBetween: 0,
              allowTouchMove: true,
              grabCursor: true,
              navigation: {
                nextEl: carouselElement.querySelector('.product-next'),
                prevEl: carouselElement.querySelector('.product-prev'),
              }
            });

            // Function to update arrow states
            const updateArrowStates = () => {
              const prevArrow = carouselElement.querySelector('.product-prev');
              const nextArrow = carouselElement.querySelector('.product-next');

              if (prevArrow) {
                if (swiperInstance.isBeginning) {
                  prevArrow.style.opacity = '0';
                  prevArrow.style.pointerEvents = 'none';
                  prevArrow.style.visibility = 'hidden';
                } else {
                  prevArrow.style.opacity = '';
                  prevArrow.style.pointerEvents = '';
                  prevArrow.style.visibility = '';
                }
              }

              if (nextArrow) {
                if (swiperInstance.isEnd) {
                  nextArrow.style.opacity = '0';
                  nextArrow.style.pointerEvents = 'none';
                  nextArrow.style.visibility = 'hidden';
                } else {
                  nextArrow.style.opacity = '';
                  nextArrow.style.pointerEvents = '';
                  nextArrow.style.visibility = '';
                }
              }
            };

            // Set initial state and add event listeners
            swiperInstance.on('slideChange', updateArrowStates);
            swiperInstance.on('reachBeginning', updateArrowStates);
            swiperInstance.on('reachEnd', updateArrowStates);

            // Initial state update
            setTimeout(updateArrowStates, 100);

            // Add touch event listeners for mobile
            const prevArrow = carouselElement.querySelector('.product-prev');
            const nextArrow = carouselElement.querySelector('.product-next');

            if (prevArrow) {
              prevArrow.addEventListener('touchstart', () => {
                if (!swiperInstance.isBeginning) {
                  swiperInstance.slidePrev();
                }
              });
            }

            if (nextArrow) {
              nextArrow.addEventListener('touchstart', () => {
                if (!swiperInstance.isEnd) {
                  swiperInstance.slideNext();
                }
              });
            }

            // Store the swiper instance on the element to avoid conflicts
            carouselElement.swiper = swiperInstance;
          }
        });
      }
    }
  }
</script>
