{% comment %}
  Video Carousel Section
  Features:
  - Swiper carousel with video slides
  - Hover to play/pause functionality
  - Thumbnail support
  - 3:4 aspect ratio
  - Responsive design
{% endcomment %}

<div class="video-carousel-section py-8 lg:py-16" id="video-carousel-section-{{ section.id }}" x-data="videoCarousel()">
  <div class="container mx-auto  sm:px-6 lg:px-8">
    <!-- Section Header -->
    {% if section.settings.title != blank or section.settings.subtitle != blank %}
      <div class="flex justify-between items-center mb-8 lg:mb-12">
        <div class="text-center flex-1">
          {% if section.settings.title != blank %}
            <h2 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-4">
              {{ section.settings.title }}
            </h2>
          {% endif %}
          {% if section.settings.subtitle != blank %}
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
              {{ section.settings.subtitle }}
            </p>
          {% endif %}
        </div>
        {% comment %} Show arrows when there are multiple videos {% endcomment %}
        {% if section.blocks.size > 1 %}
          {% render 'carousel-arrows' %}
        {% endif %}
      </div>
    {% endif %}

    <!-- Video Carousel -->
    {% if section.blocks.size > 0 %}
      <div class="relative">
        <div
          class="video-carousel swiper overflow-hidden"
          data-carousel-id="video-carousel-{{ section.id }}"
          id="video-carousel-{{ section.id }}"
        >
          <div class="swiper-wrapper">
            {% for block in section.blocks %}
              {% if block.type == 'video_slide' %}
                <div class="swiper-slide">
                  {% render 'video-slide', block: block, aspect_ratio: '3/4' %}
                </div>
              {% endif %}
            {% endfor %}
          </div>

          <!-- Pagination -->
          {% if section.settings.show_pagination %}
            <div class="swiper-pagination mt-8 flex justify-center gap-2"></div>
          {% endif %}
        </div>
      </div>
    {% else %}
      <!-- Empty State -->
      <div class="text-center py-16">
        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No videos added yet</h3>
        <p class="text-gray-600">Add video slides to display your content</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
  function videoCarousel() {
    return {
      swiper: null,

      init() {
        this.$nextTick(() => {
          this.initializeCarousel();
        });
      },

      initializeCarousel() {
        const carouselElement = this.$el.querySelector('.video-carousel');

        if (carouselElement && typeof Swiper !== 'undefined') {
          // Check if already initialized
          if (carouselElement.swiper) {
            return;
          }

          // Initialize Swiper
          this.swiper = new Swiper(carouselElement, {
            direction: 'horizontal',
            slidesPerView: {{ section.settings.slides_mobile | default: 1 }}.2, // Mobile with peek
            spaceBetween: {{ section.settings.slide_spacing | default: 20 }},
            loop: {{ section.settings.loop | json }},
            centeredSlides: false,
            grabCursor: false,
            touchRatio: 1,
            touchAngle: 45,
            simulateTouch: true,
            navigation: {
              nextEl: '.carousel-next',
              prevEl: '.carousel-prev',
            },
            autoplay: {{ section.settings.autoplay | json }} ? {
              delay: {{ section.settings.autoplay_delay | default: 5000 }},
              disableOnInteraction: false,
              pauseOnMouseEnter: true,
            } : false,
            speed: {{ section.settings.transition_speed | default: 800 }},

            // Responsive breakpoints
            breakpoints: {
              640: {
                slidesPerView: {{ section.settings.slides_mobile | default: 1 }}.2, // Mobile with peek
                spaceBetween: {{ section.settings.slide_spacing | default: 20 }}
              },
              768: {
                slidesPerView: {{ section.settings.slides_tablet | default: 2 }}.1, // Tablet with peek
                spaceBetween: {{ section.settings.slide_spacing | default: 20 }}
              },
              1024: {
                slidesPerView: {{ section.settings.slides_desktop | default: 3 }}.1, // Desktop with peek
                spaceBetween: {{ section.settings.slide_spacing | default: 20 }}
              },
              1280: {
                slidesPerView: {{ section.settings.slides_large_desktop | default: 4 }}.1, // Large desktop with peek
                spaceBetween: {{ section.settings.slide_spacing | default: 20 }}
              }
            },

            // Events for arrow states
            on: {
              init: function() {
                updateVideoArrowStates(this);
              },
              slideChange: function() {
                updateVideoArrowStates(this);
              },
              reachBeginning: function() {
                updateVideoArrowStates(this);
              },
              reachEnd: function() {
                updateVideoArrowStates(this);
              },
            },



            // Pagination
            {% if section.settings.show_pagination %}
            pagination: {
              el: carouselElement.querySelector('.swiper-pagination'),
              clickable: true,
              renderBullet: function (index, className) {
                return '<span class="' + className + ' w-3 h-3 rounded-full bg-gray-300 cursor-pointer transition-all duration-200 hover:bg-gray-400"></span>';
              },
            },
            {% endif %}


          });

          // Store swiper instance
          carouselElement.swiper = this.swiper;
        }
      },

      destroy() {
        if (this.swiper) {
          this.swiper.destroy();
          this.swiper = null;
        }
      }
    }
  }

  // Function to update arrow states for video carousel
  function updateVideoArrowStates(swiper) {
    const sectionContainer = document.getElementById('video-carousel-section-{{ section.id }}');
    if (!sectionContainer) return;

    const prevArrow = sectionContainer.querySelector('.carousel-prev');
    const nextArrow = sectionContainer.querySelector('.carousel-next');

    if (prevArrow) {
      if (swiper.isBeginning) {
        prevArrow.style.opacity = '0.3';
        prevArrow.style.cursor = 'not-allowed';
        prevArrow.disabled = true;
      } else {
        prevArrow.style.opacity = '1';
        prevArrow.style.cursor = 'pointer';
        prevArrow.disabled = false;
      }
    }

    if (nextArrow) {
      if (swiper.isEnd) {
        nextArrow.style.opacity = '0.3';
        nextArrow.style.cursor = 'not-allowed';
        nextArrow.disabled = true;
      } else {
        nextArrow.style.opacity = '1';
        nextArrow.style.cursor = 'pointer';
        nextArrow.disabled = false;
      }
    }
  }
</script>

<style>
  /* Custom Swiper Styles */
  .video-carousel {
    width: 100%;
    height: 100%;
  }

  .video-carousel .swiper-wrapper {
    display: flex;
    transition-timing-function: var(--swiper-wrapper-transition-timing-function, initial);
  }

  .video-carousel .swiper-slide {
    flex-shrink: 0;
    width: 100%;
    height: 100%;
    position: relative;
    transition-property: transform;
  }

  .video-carousel .swiper-pagination-bullet {
    @apply bg-gray-300;
  }

  .video-carousel .swiper-pagination-bullet-active {
    @apply bg-gray-800;
  }

  /* Ensure videos maintain aspect ratio */
  .video-slide-container {
    width: 100%;
  }
</style>

{% schema %}
{
  "name": "Video Carousel",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Video Gallery"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Section Subtitle",
      "default": "Discover our latest content"
    },
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "range",
      "id": "slides_mobile",
      "min": 1,
      "max": 3,
      "step": 1,
      "label": "Slides per view (Mobile)",
      "default": 1
    },
    {
      "type": "range",
      "id": "slides_tablet",
      "min": 1,
      "max": 4,
      "step": 1,
      "label": "Slides per view (Tablet)",
      "default": 2
    },
    {
      "type": "range",
      "id": "slides_desktop",
      "min": 1,
      "max": 5,
      "step": 1,
      "label": "Slides per view (Desktop)",
      "default": 3
    },
    {
      "type": "range",
      "id": "slides_large_desktop",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Slides per view (Large Desktop)",
      "default": 4
    },
    {
      "type": "range",
      "id": "slide_spacing",
      "min": 0,
      "max": 50,
      "step": 5,
      "label": "Space between slides (px)",
      "default": 20
    },
    {
      "type": "checkbox",
      "id": "loop",
      "label": "Loop slides",
      "default": true
    },

    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Show pagination dots",
      "default": true
    },
    {
      "type": "header",
      "content": "Autoplay Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "min": 2000,
      "max": 9500,
      "step": 500,
      "label": "Autoplay delay (ms)",
      "default": 5000,
      "info": "Time between slide transitions"
    },
    {
      "type": "range",
      "id": "transition_speed",
      "min": 300,
      "max": 2000,
      "step": 100,
      "label": "Transition speed (ms)",
      "default": 800
    },
    {
      "type": "header",
      "content": "Video Settings"
    },
    {
      "type": "paragraph",
      "content": "Videos will automatically play muted and loop continuously."
    }
  ],
  "blocks": [
    {
      "type": "video_slide",
      "name": "Video Slide",
      "settings": [
        {
          "type": "video",
          "id": "video_file",
          "label": "Video File",
          "info": "Upload a video file (MP4 recommended)"
        },

        {
          "type": "text",
          "id": "video_title",
          "label": "Video Title"
        },
        {
          "type": "textarea",
          "id": "video_description",
          "label": "Video Description"
        },
        {
          "type": "url",
          "id": "video_link",
          "label": "Video Link",
          "info": "Optional: Link when video is clicked"
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link Text",
          "default": "Watch Full Video"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Video Carousel",
      "blocks": [
        {
          "type": "video_slide"
        },
        {
          "type": "video_slide"
        },
        {
          "type": "video_slide"
        }
      ]
    }
  ]
}
{% endschema %}
