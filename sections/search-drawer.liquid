{% comment %}
  Search Drawer Section
  Features:
  - Slide-in drawer from right
  - Real-time search with debouncing
  - Search history with localStorage
  - Featured collections and products
  - Category grid and product carousels
  - Responsive design
  - Fully customizable via schema
{% endcomment %}

<div
  x-cloak
  x-data="searchDrawer()"
  x-show="isOpen"
  class="fixed inset-0 z-40 overflow-hidden"
  @keydown.escape.window="closeDrawer()"
  @search:open.window="openDrawer()"
>
  <!-- Backdrop -->
  <div
    x-cloak
    x-show="isOpen"
    x-transition:enter="transition ease-out duration-500"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-400"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="absolute inset-0 bg-black/70"
    @click="closeDrawer()"
  ></div>

  <!-- Drawer -->
  <div
    x-cloak
    x-show="isOpen"
    x-transition:enter="transform transition ease-out duration-350"
    x-transition:enter-start="translate-x-full "
    x-transition:enter-end="translate-x-0 "
    x-transition:leave="transform transition ease-in duration-300"
    x-transition:leave-start="translate-x-0 "
    x-transition:leave-end="translate-x-full "
    class="absolute right-0 top-0 h-full py-3  w-[88vw] lg:w-[{{ section.settings.drawer_width | default: 420 }}px] bg-white shadow-xl flex flex-col overflow-hidden transform-gpu will-change-transform"
  >
    <!-- Header -->
    <div class="lg:px-6 px-4  flex-shrink-0">
      <div class="flex items-center justify-between mb-4">
        <h5>{{ section.settings.search_title | default: 'Search' }}</h5>
        <button
          @click="closeDrawer()"
          class="text-gray-400 hover:text-gray-600 transition-colors duration-200 "
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Search Input -->
      <div class="relative">
        <input
          type="text"
          x-model="searchQuery"
          @input="handleSearch"
          @keydown.enter="viewAllResults"
          placeholder="{{ section.settings.search_placeholder | default: 'Search products, categories...' }}"
          class="w-full pl-8 py-3 border-b border-black/20 focus:border-black/50   focus:ring-0 focus:outline-none   transition-all duration-200"
        >
        {% render 'search-icon', class: 'absolute left-0 top-1/2 -translate-y-1/2 w-5 h-5 text-black' %}

        <button
          x-show="searchQuery.length > 0"
          x-transition.scale.origin.right.duration.200ms
          @click="clearSearch"
          class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-700 hover:text-gray-900 transition-colors duration-200"
        >
          <p class="body-sm lg:body underline cursor-pointer opacity-80">
            {{ section.settings.clear_text | default: 'Clear' }}
          </p>
        </button>
      </div>

      <!-- View All Button (below search input) -->
      <div
        x-show="searchQuery.length > 0 && searchResults.length > 0"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 -translate-y-2"
        x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 -translate-y-2"
        class="lg:px-6 px-4 pb-4"
      >
        <button
          @click="viewAllResults"
          class="w-full text-center py-2 text-gray-600 hover:text-gray-800 underline transition-colors duration-200"
        >
          {{ section.settings.view_all_text | default: 'Ver todos' }}
        </button>
      </div>
    </div>

    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto scrollbar-hide">
      <!-- Security Icons Section -->
      <div
        x-show="searchQuery.length === 0"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 -translate-y-2"
        x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 -translate-y-2"
      >
        {% if section.settings.show_security_icons %}
          <div class="py-6 px-4 lg:px-6 border-b border-gray-200">
            <div class="grid grid-cols-3 gap-4 text-center">
              <!-- Security Icon 1 -->
              {% if section.settings.show_security_icon_1 %}
                <div class="flex flex-col items-center space-y-2">
                  {% if section.settings.security_icon_1 %}
                    <img
                      src="{{ section.settings.security_icon_1 | image_url: width: 48 }}"
                      alt="{{ section.settings.security_title_1 }}"
                      width="48"
                      height="48"
                      class="w-12 h-12 object-contain"
                    >
                  {% else %}
                    <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                  {% endif %}
                  {% if section.settings.security_title_1 != blank %}
                    <p class="body-xs font-semibold text-gray-900">{{ section.settings.security_title_1 }}</p>
                  {% endif %}
                  {% if section.settings.security_description_1 != blank %}
                    <p class="body-xs text-gray-600">{{ section.settings.security_description_1 }}</p>
                  {% endif %}
                </div>
              {% endif %}

              <!-- Security Icon 2 -->
              {% if section.settings.show_security_icon_2 %}
                <div class="flex flex-col items-center space-y-2">
                  {% if section.settings.security_icon_2 %}
                    <img
                      src="{{ section.settings.security_icon_2 | image_url: width: 48 }}"
                      alt="{{ section.settings.security_title_2 }}"
                      width="48"
                      height="48"
                      class="w-12 h-12 object-contain"
                    >
                  {% else %}
                    <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                    </svg>
                  {% endif %}
                  {% if section.settings.security_title_2 != blank %}
                    <p class="body-xs font-semibold text-gray-900">{{ section.settings.security_title_2 }}</p>
                  {% endif %}
                  {% if section.settings.security_description_2 != blank %}
                    <p class="body-xs text-gray-600">{{ section.settings.security_description_2 }}</p>
                  {% endif %}
                </div>
              {% endif %}

              <!-- Security Icon 3 -->
              {% if section.settings.show_security_icon_3 %}
                <div class="flex flex-col items-center space-y-2">
                  {% if section.settings.security_icon_3 %}
                    <img
                      src="{{ section.settings.security_icon_3 | image_url: width: 48 }}"
                      alt="{{ section.settings.security_title_3 }}"
                      width="48"
                      height="48"
                      class="w-12 h-12 object-contain"
                    >
                  {% else %}
                    <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                    </svg>
                  {% endif %}
                  {% if section.settings.security_title_3 != blank %}
                    <p class="body-xs font-semibold text-gray-900">{{ section.settings.security_title_3 }}</p>
                  {% endif %}
                  {% if section.settings.security_description_3 != blank %}
                    <p class="body-xs text-gray-600">{{ section.settings.security_description_3 }}</p>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}

        <!-- CTA Section -->
        {% if section.settings.show_cta_section %}
          <div class="py-6 px-4 lg:px-6 border-b border-gray-200">
            {% if section.settings.cta_title != blank %}
              <h5 class="mb-3 text-center">{{ section.settings.cta_title }}</h5>
            {% endif %}

            {% if section.settings.cta_description != blank %}
              <p class="body text-gray-600 text-center mb-4">{{ section.settings.cta_description }}</p>
            {% endif %}

            {% if section.settings.cta_button_text != blank and section.settings.cta_button_link != blank %}
              <div class="text-center">
                <a
                  href="{{ section.settings.cta_button_link }}"
                  class="inline-block body font-semibold py-3 px-6 bg-primary border border-primary text-white hover:bg-transparent hover:border-black hover:text-black transition-colors duration-300"
                  @click="closeDrawer()"
                >
                  {{ section.settings.cta_button_text }}
                </a>
              </div>
            {% endif %}
          </div>
        {% endif %}

        <!-- Search History -->
        <div
          x-show="searchHistory.length > 0"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 -translate-y-2"
          x-transition:enter-end="opacity-100 translate-y-0"
          class="lg:p-6 p-4 "
        >
          <div class="flex items-center justify-between mb-4">
            <h5>
              {{ section.settings.history_title | default: 'Recent Searches' }}
            </h5>
            <button
              @click="clearHistory"
              class="body-sm text-black underline transition-colors duration-200"
            >
              {{ section.settings.clear_all_text | default: 'Clear all' }}
            </button>
          </div>

          <div class="space-y-1">
            <template x-for="term in searchHistory" :key="term">
              <div class="flex items-center justify-start w-full text-left text-black rounded-lg">
                <!-- Left side: Clock icon + search term -->
                <button
                  @click="searchFromHistory(term)"
                  class="flex items-center space-x-2  text-left"
                >
                  <span x-text="term" class="truncate"></span>
                </button>

                <!-- Right side: Remove button close to text -->
                <button
                  @click.stop="removeFromHistory(term)"
                  class="flex-shrink-0 ml-2 p-1 text-black"
                  :title="`Remove '${term}' from history`"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            </template>
          </div>
        </div>

        <!-- Filters Section -->
        <div class="py-6 px-4 lg:px-6 space-y-6 border-b border-gray-200">
          <!-- Filter Toggle Button -->
          <button
            @click="showFilters = !showFilters"
            class="w-full flex items-center justify-between py-3 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            <span class="body font-semibold">Filtrar</span>
            <svg
              class="w-5 h-5 transition-transform"
              :class="showFilters ? 'rotate-180' : ''"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <!-- Filters Content -->
          <div
            x-show="showFilters"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 -translate-y-2"
            x-transition:enter-end="opacity-100 translate-y-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 translate-y-0"
            x-transition:leave-end="opacity-0 -translate-y-2"
            class="space-y-6"
          >
            <!-- Estilo Filter -->
            <div>
              <button
                @click="expandedFilter === 'estilo' ? expandedFilter = null : expandedFilter = 'estilo'"
                class="w-full flex items-center justify-between mb-3"
              >
                <h6 class="body font-semibold">Estilo</h6>
                <svg
                  class="w-4 h-4 transition-transform"
                  :class="expandedFilter === 'estilo' ? '' : 'rotate-180'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              <div
                x-show="expandedFilter === 'estilo'"
                x-collapse
                class="flex flex-wrap gap-2"
              >
                <template x-for="estilo in availableEstilos" :key="estilo">
                  <button
                    @click="toggleFilter('estilos', estilo)"
                    class="py-2 px-4 rounded-full border transition-all body-sm"
                    :class="filters.estilos.includes(estilo) ? 'bg-black text-white border-black' : 'bg-white text-black border-gray-300 hover:border-black'"
                    x-text="estilo"
                  ></button>
                </template>
              </div>
            </div>

            <!-- Marcas Filter -->
            <div>
              <button
                @click="expandedFilter === 'marcas' ? expandedFilter = null : expandedFilter = 'marcas'"
                class="w-full flex items-center justify-between mb-3"
              >
                <h6 class="body font-semibold">Marcas</h6>
                <svg
                  class="w-4 h-4 transition-transform"
                  :class="expandedFilter === 'marcas' ? '' : 'rotate-180'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              <div
                x-show="expandedFilter === 'marcas'"
                x-collapse
                class="flex flex-wrap gap-2"
              >
                <template x-for="marca in availableMarcas" :key="marca">
                  <button
                    @click="toggleFilter('marcas', marca)"
                    class="py-2 px-4 rounded-full border transition-all body-sm"
                    :class="filters.marcas.includes(marca) ? 'bg-black text-white border-black' : 'bg-white text-black border-gray-300 hover:border-black'"
                    x-text="marca"
                  ></button>
                </template>
              </div>
            </div>

            <!-- Género Filter -->
            <div>
              <button
                @click="expandedFilter === 'genero' ? expandedFilter = null : expandedFilter = 'genero'"
                class="w-full flex items-center justify-between mb-3"
              >
                <h6 class="body font-semibold">Género</h6>
                <svg
                  class="w-4 h-4 transition-transform"
                  :class="expandedFilter === 'genero' ? '' : 'rotate-180'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              <div
                x-show="expandedFilter === 'genero'"
                x-collapse
                class="flex flex-wrap gap-2"
              >
                <template x-for="genero in availableGeneros" :key="genero">
                  <button
                    @click="toggleFilter('generos', genero)"
                    class="py-2 px-4 rounded-full border transition-all body-sm"
                    :class="filters.generos.includes(genero) ? 'bg-black text-white border-black' : 'bg-white text-black border-gray-300 hover:border-black'"
                    x-text="genero"
                  ></button>
                </template>
              </div>
            </div>

            <!-- Categoría Filter (Ropa/Calzado) -->
            <div>
              <button
                @click="expandedFilter === 'categoria' ? expandedFilter = null : expandedFilter = 'categoria'"
                class="w-full flex items-center justify-between mb-3"
              >
                <h6 class="body font-semibold">Categoría</h6>
                <svg
                  class="w-4 h-4 transition-transform"
                  :class="expandedFilter === 'categoria' ? '' : 'rotate-180'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              <div
                x-show="expandedFilter === 'categoria'"
                x-collapse
                class="flex flex-wrap gap-2"
              >
                <button
                  @click="toggleFilter('categorias', 'Ropa')"
                  class="py-2 px-4 rounded-full border transition-all body-sm"
                  :class="filters.categorias.includes('Ropa') ? 'bg-black text-white border-black' : 'bg-white text-black border-gray-300 hover:border-black'"
                >
                  Ropa
                </button>
                <button
                  @click="toggleFilter('categorias', 'Calzado')"
                  class="py-2 px-4 rounded-full border transition-all body-sm"
                  :class="filters.categorias.includes('Calzado') ? 'bg-black text-white border-black' : 'bg-white text-black border-gray-300 hover:border-black'"
                >
                  Calzado
                </button>
              </div>
            </div>

            <!-- Color Filter -->
            <div>
              <button
                @click="expandedFilter === 'color' ? expandedFilter = null : expandedFilter = 'color'"
                class="w-full flex items-center justify-between mb-3"
              >
                <h6 class="body font-semibold">Color</h6>
                <svg
                  class="w-4 h-4 transition-transform"
                  :class="expandedFilter === 'color' ? '' : 'rotate-180'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              <div
                x-show="expandedFilter === 'color'"
                x-collapse
                class="flex flex-wrap gap-2"
              >
                <template x-for="color in availableColors" :key="color">
                  <button
                    @click="toggleFilter('colores', color)"
                    class="py-2 px-4 rounded-full border transition-all body-sm"
                    :class="filters.colores.includes(color) ? 'bg-black text-white border-black' : 'bg-white text-black border-gray-300 hover:border-black'"
                    x-text="color"
                  ></button>
                </template>
              </div>
            </div>

            <!-- Talla Filter -->
            <div>
              <button
                @click="expandedFilter === 'talla' ? expandedFilter = null : expandedFilter = 'talla'"
                class="w-full flex items-center justify-between mb-3"
              >
                <h6 class="body font-semibold">Talla</h6>
                <svg
                  class="w-4 h-4 transition-transform"
                  :class="expandedFilter === 'talla' ? '' : 'rotate-180'"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              <div
                x-show="expandedFilter === 'talla'"
                x-collapse
                class="grid grid-cols-4 gap-2"
              >
                <template x-for="talla in availableTallas" :key="talla">
                  <button
                    @click="toggleFilter('tallas', talla)"
                    class="py-2 px-3 rounded-lg border transition-all body-sm text-center"
                    :class="filters.tallas.includes(talla) ? 'bg-black text-white border-black' : 'bg-white text-black border-gray-300 hover:border-black'"
                    x-text="talla"
                  ></button>
                </template>
              </div>
            </div>

            <!-- Filter Action Buttons -->
            <div class="flex gap-3 pt-4 border-t border-gray-200">
              <button
                @click="clearAllFilters()"
                class="flex-1 py-3 px-6 border border-gray-300 text-black font-semibold rounded-lg hover:bg-gray-50 transition-colors body"
              >
                Limpiar
              </button>
              <button
                @click="applyFilters()"
                class="flex-1 py-3 px-6 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-colors body"
              >
                Aplicar Filtros
              </button>
            </div>
          </div>
        </div>

        <!-- Products -->
        {% if section.settings.show_product_carousel %}
          <div class="py-6 space-y-4">
            <div class=" lg:px-6">
              <h5>
                {{ section.settings.product_carousel_title | default: 'Featured Products' }}
              </h5>
            </div>

            {% assign products = '' %}
            {% case section.settings.product_source %}
              {% when 'collection' %}
                {% if section.settings.collection != blank %}
                  {% assign products = section.settings.collection.products %}
                {% endif %}
              {% when 'tags' %}
                {% if section.settings.product_tags != blank %}
                  {% assign tag_array = section.settings.product_tags | split: ',' %}
                  {% assign products = collections.all.products %}
                  {% for tag in tag_array %}
                    {% assign tag_trimmed = tag | strip %}
                    {% assign products = products | where: 'tags', tag_trimmed %}
                  {% endfor %}
                {% endif %}
              {% when 'manual' %}
                {% assign products = section.settings.products %}
            {% endcase %}

            {% if products != blank and products.count > 0 %}
              {% assign products_shown = 0 %}
              {% capture products_content %}
                {% for product in products %}
                  {% if product.available and products_shown < section.settings.max_products %}
                    <div class="swiper-slide">
                      {% render 'product-card',
                        product: product,
                        show_badges: true,
                        show_rating: true,
                        mobile_layout: true
                      %}
                    </div>
                    {% assign products_shown = products_shown | plus: 1 %}
                  {% endif %}
                {% endfor %}
              {% endcapture %}

              {% render 'generic-carousel',
                carousel_id: 'search-products',
                carousel_class: 'search-products-carousel',
                content: products_content,
                show_arrows: false,
                slides_per_view_mobile: 1.5,
                slides_per_view_desktop: 2.2,
                space_between_mobile: 2,
                space_between_desktop: 4,
                centered_slides: false,
                free_mode: true,
                total_items: products_shown,
                padding_left_mobile: 24,
                padding_right_mobile: 24,
                padding_left_desktop: 24,
                padding_right_desktop: 24
              %}
            {% else %}
              <p class="text-gray-500 text-center py-8">No products available</p>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- Matching Categories -->
      <div
        x-show="searchQuery.length > 0 && matchingCategories.length > 0"
        x-transition:enter="transition ease-out duration-400"
        x-transition:enter-start="opacity-0 translate-y-4"
        x-transition:enter-end="opacity-100 translate-y-0"
        class="lg:p-6 p-4 space-y-4 "
      >
        <h5>{{ section.settings.matching_categories_title | default: 'Categorías que coinciden' }}</h5>

        <div class="flex flex-col gap-2">
          <template x-for="category in matchingCategories" :key="category.id">
            <a
              :href="category.url"
              class="body"
              x-text="`'${category.title}'`"
              @click="addToHistory(searchQuery); closeDrawer()"
            ></a>
          </template>
        </div>
      </div>

      <!-- Search Results -->
      <div
        x-show="searchQuery.length > 0 && searchResults.length > 0"
        x-transition:enter="transition ease-out duration-400"
        x-transition:enter-start="opacity-0 translate-y-4"
        x-transition:enter-end="opacity-100 translate-y-0"
        class="p-6 space-y-4"
        x-data="{ layoutOption: {{ settings.default_gallery_layout_desktop | default: 2 }} }"
      >
        <div class="flex items-center justify-between">
          <h5>
            {{ section.settings.results_title | default: 'Productos encontrados' }} (<span
              x-text="searchResults.length"
            ></span
            >)
          </h5>

          <!-- Mini Layout Toggle for Search Results -->
          <div class="flex gap-1">
            <button @click="layoutOption = 2" class="p-1">
              <svg
                class="size-4 cursor-pointer transition-opacity"
                :class="layoutOption == 2 ? 'opacity-100' : 'opacity-40'"
                viewBox="0 0 24 24"
                fill="none"
              >
                <path fill-rule="evenodd" clip-rule="evenodd" d="M13 5h6v14h-6V5Zm-2-2h10v18H3V3h8Zm0 16H5V5h6v14Z" fill="currentColor"/>
              </svg>
            </button>
            <button @click="layoutOption = 3" class="p-1">
              <svg
                class="size-4 cursor-pointer transition-opacity"
                :class="layoutOption == 3 ? 'opacity-100' : 'opacity-40'"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
              >
                <path d="M 10.83 16.17 L 15.83 16.17 L 15.83 11.17 L 10.83 11.17 Z M 10.833 9.167 L 15.833 9.167 L 15.833 4.167 L 10.833 4.167 Z M 17.5 2.5 L 17.5 17.5 L 2.5 17.5 L 2.5 2.5 Z M 9.167 4.167 L 4.167 4.167 L 4.167 9.167 L 9.167 9.167 Z M 9.167 11.167 L 4.167 11.167 L 4.167 16.167 L 9.167 16.167 Z" fill="rgba(0,0,0,1)"/>
              </svg>
            </button>
          </div>
        </div>

        <div
          class="grid gap-0.5 transition-all duration-300"
          :class="
            {
              'grid-cols-2': layoutOption === 2,
              'grid-cols-3': layoutOption === 3
            }
          "
        >
          <template x-for="result in searchResults" :key="result.id">
            <div class="product-result-card">
              <a
                :href="result.url"
                class="group flex flex-col"
                @click="addToHistory(searchQuery); closeDrawer()"
              >
                <div
                  class="relative overflow-hidden aspect-[3/4] bg-gray-100"
                  :class="layoutOption === 3 ? 'mb-0' : 'mb-3'"
                >
                  <img
                    :src="result.featured_image.url"
                    :alt="result.title"
                    class="w-full h-full object-cover transition-transform duration-300"
                    width="400"
                    height="400"
                    loading="lazy"
                  >
                  <div class="absolute top-2 left-2">
                    <span class="bg-white/90 backdrop-blur-sm text-black py-1 px-2 text-xs font-medium">
                      {{ section.settings.new_badge_text | default: 'Nuevo' }}
                    </span>
                  </div>
                </div>

                <!-- Product Info - Hide when layout is 3 -->
                <div
                  x-show="layoutOption !== 3"
                  class="space-y-2"
                >
                  <p
                    class="body-sm lg:body font-semibold"
                    x-text="cleanProductTitle(result.title)"
                  ></p>
                </div>
              </a>
            </div>
          </template>
        </div>

        <div x-show="searchResults.length > 10" class="mt-6 text-center">
          <button
            @click="viewAllResults"
            class="px-6 py-3 bg-black text-white font-medium rounded-lg hover:bg-gray-800 transition-all duration-200 "
          >
            {{ section.settings.view_all_text | default: 'Ver todos' }} los <span x-text="searchResults.length"></span>
            {{ section.settings.results_text | default: 'resultados' }}
          </button>
        </div>
      </div>

      <!-- No Results -->
      <div
        x-show="searchQuery.length > 0 && searchResults.length === 0 && !isSearching"
        x-transition.scale.duration.400ms
        class="p-6 text-center"
      >
        <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 011 4z"/>
        </svg>
        <h5>{{ section.settings.no_results_title | default: 'No results found' }}</h5>
        <p class="body-sm lg:body">
          {{ section.settings.no_results_text | default: 'Try searching with different keywords' }}
        </p>
      </div>

      <!-- Loading -->
      <div
        x-show="isSearching"
        x-transition.opacity.duration.300ms
        class="p-6 text-center"
      >
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
        <p class="text-gray-500 mt-2">{{ section.settings.searching_text | default: 'Searching...' }}</p>
      </div>
    </div>
  </div>
</div>

<script>
  function searchDrawer() {
    return {
      isOpen: false,
      searchQuery: '',
      searchResults: [],
      allSearchResults: [], // Store unfiltered results
      matchingCategories: [],
      searchHistory: [],
      isSearching: false,
      searchTimeout: null,
      scrollY: 0, // Store scroll position for drawer

      // Filter UI state
      showFilters: false,
      expandedFilter: null,

      // Filter selections
      filters: {
        estilos: [],
        marcas: [],
        generos: [],
        categorias: [],
        colores: [],
        tallas: []
      },

      // Available filter options (will be populated from search results)
      availableEstilos: ['Balocesto', 'Caminata', 'Casual', 'Casual Urbano', 'Casual Lifestyle', 'Clasico', 'Deportivo', 'Entrenamiento', 'Gimnasio', 'Gym', 'Ligero', 'Más Vendidos', 'Outdoor', 'Para Caminar', 'Plataforma', 'Running', 'Running Retro', 'Running Treto', 'Senderismo', 'Streetwear', 'Trail', 'Trail Running', 'Training', 'Urbano', 'Uso Diario', 'Zapatillas Reto'],
      availableMarcas: ['Nike', 'Adidas', 'Puma', 'Skechers', 'Le Coq Sportif', 'Diesel', 'Clemont', 'Under Armour', 'Converse', 'New Balance', 'Merrel', 'Reebok', 'Polo', 'Urban'],
      availableGeneros: ['Masculino', 'Femenino', 'Unisex', 'Niños'],
      availableColors: [],
      availableTallas: [],

      init() {
        this.loadSearchHistory();
      },

      openDrawer() {
        this.isOpen = true;
        // Store current scroll position
        this.scrollY = window.scrollY;
        document.body.style.overflow = 'hidden';
        document.body.classList.add('search-drawer-open');
        // Focus after the transition to prevent abrupt scroll/focus jump
        this.$nextTick(() => {
          const input = this.$el.querySelector('input[type="text"]');
          setTimeout(() => input?.focus(), 380);
        });
      },

      closeDrawer() {
        this.isOpen = false;
        document.body.style.overflow = '';
        document.body.classList.remove('search-drawer-open');
        setTimeout(() => {
          this.searchQuery = '';
          this.searchResults = [];
          this.matchingCategories = [];
        }, 300);
      },

      handleSearch() {
        clearTimeout(this.searchTimeout);
        if (this.searchQuery.length < 2) {
          this.searchResults = [];
          return;
        }
        this.searchTimeout = setTimeout(() => this.performSearch(), 300);
      },

      async performSearch() {
        if (this.searchQuery.length < 2) return;

        this.isSearching = true;
        try {
          // Search for products
          const productsResponse = await fetch(
            `/search/suggest.json?q=${encodeURIComponent(this.searchQuery)}&resources[type]=product&resources[limit]=50`
          );
          const productsData = await productsResponse.json();
          this.allSearchResults = productsData.resources.results.products || [];
          this.searchResults = [...this.allSearchResults];

          // Extract available colors and sizes from results
          this.extractFilterOptions();

          // Search for collections/categories
          const collectionsResponse = await fetch(
            `/search/suggest.json?q=${encodeURIComponent(
              this.searchQuery
            )}&resources[type]=collection&resources[limit]=5`
          );
          const collectionsData = await collectionsResponse.json();
          this.matchingCategories = collectionsData.resources.results.collections || [];

          if (this.searchResults.length > 0 || this.matchingCategories.length > 0) {
            this.addToHistory(this.searchQuery);
          }
        } catch (error) {
          console.error('Search error:', error);
          this.searchResults = [];
          this.allSearchResults = [];
          this.matchingCategories = [];
        } finally {
          this.isSearching = false;
        }
      },

      extractFilterOptions() {
        // Extract unique colors
        const colors = new Set();
        const tallas = new Set();

        this.allSearchResults.forEach(product => {
          // Extract colors from options
          if (product.options) {
            product.options.forEach(option => {
              if (option.name === 'Color' && option.values) {
                option.values.forEach(value => colors.add(value));
              }
            });
          }

          // Extract sizes from variants
          if (product.variants) {
            product.variants.forEach(variant => {
              if (variant.option1) tallas.add(variant.option1);
              if (variant.option2) tallas.add(variant.option2);
              if (variant.option3) tallas.add(variant.option3);
            });
          }
        });

        this.availableColors = Array.from(colors).sort();
        this.availableTallas = Array.from(tallas).sort((a, b) => {
          const numA = parseFloat(a);
          const numB = parseFloat(b);
          if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
          return a.localeCompare(b);
        });
      },

      toggleFilter(filterType, value) {
        const filterArray = this.filters[filterType];
        const index = filterArray.indexOf(value);

        if (index > -1) {
          filterArray.splice(index, 1);
        } else {
          filterArray.push(value);
        }
      },

      applyFilters() {
        if (this.allSearchResults.length === 0) {
          this.searchResults = [];
          return;
        }

        this.searchResults = this.allSearchResults.filter(product => {
          // Filter by Estilo (tags)
          if (this.filters.estilos.length > 0) {
            const productTags = product.tags || [];
            const hasEstilo = this.filters.estilos.some(estilo =>
              productTags.some(tag => tag.toLowerCase().includes(estilo.toLowerCase()))
            );
            if (!hasEstilo) return false;
          }

          // Filter by Marca (vendor)
          if (this.filters.marcas.length > 0) {
            const hasVendor = this.filters.marcas.some(marca =>
              product.vendor && product.vendor.toLowerCase().includes(marca.toLowerCase())
            );
            if (!hasVendor) return false;
          }

          // Filter by Género (metafield - we'll need to check if available in API)
          if (this.filters.generos.length > 0) {
            // Note: Shopify API might not include metafields in search results
            // This filter might need adjustment based on actual API response
            if (product.metafields && product.metafields.target_gender) {
              const hasGenero = this.filters.generos.includes(product.metafields.target_gender);
              if (!hasGenero) return false;
            }
          }

          // Filter by Categoría (product_type)
          if (this.filters.categorias.length > 0) {
            const hasCategoria = this.filters.categorias.some(cat =>
              product.product_type && product.product_type.toLowerCase().includes(cat.toLowerCase())
            );
            if (!hasCategoria) return false;
          }

          // Filter by Color (options)
          if (this.filters.colores.length > 0) {
            let hasColor = false;
            if (product.options) {
              product.options.forEach(option => {
                if (option.name === 'Color' && option.values) {
                  hasColor = this.filters.colores.some(color => option.values.includes(color));
                }
              });
            }
            if (!hasColor) return false;
          }

          // Filter by Talla (variants)
          if (this.filters.tallas.length > 0) {
            let hasTalla = false;
            if (product.variants) {
              hasTalla = product.variants.some(variant =>
                this.filters.tallas.includes(variant.option1) ||
                this.filters.tallas.includes(variant.option2) ||
                this.filters.tallas.includes(variant.option3)
              );
            }
            if (!hasTalla) return false;
          }

          return true;
        });
      },

      clearAllFilters() {
        this.filters = {
          estilos: [],
          marcas: [],
          generos: [],
          categorias: [],
          colores: [],
          tallas: []
        };
        this.searchResults = [...this.allSearchResults];
      },

      clearSearch() {
        this.searchQuery = '';
        this.searchResults = [];
        this.matchingCategories = [];
      },

      addToHistory(term) {
        if (!term?.trim()) return;
        const trimmedTerm = term.trim();
        this.searchHistory = [trimmedTerm, ...this.searchHistory.filter((item) => item !== trimmedTerm)].slice(0, 3);
        this.saveSearchHistory();
      },

      removeFromHistory(term) {
        this.searchHistory = this.searchHistory.filter((item) => item !== term);
        this.saveSearchHistory();
      },

      clearHistory() {
        this.searchHistory = [];
        this.saveSearchHistory();
      },

      searchFromHistory(term) {
        this.searchQuery = term;
        this.performSearch();
      },

      loadSearchHistory() {
        try {
          const saved = localStorage.getItem('search_history');
          if (saved) this.searchHistory = JSON.parse(saved);
        } catch (error) {
          console.error('Error loading search history:', error);
        }
      },

      saveSearchHistory() {
        try {
          localStorage.setItem('search_history', JSON.stringify(this.searchHistory));
        } catch (error) {
          console.error('Error saving search history:', error);
        }
      },

      viewAllResults() {
        const searchUrl = `/search?q=${encodeURIComponent(this.searchQuery)}`;
        this.addToHistory(this.searchQuery);
        this.closeDrawer();
        window.location.href = searchUrl;
      },

      cleanProductTitle(title) {
        if (!title) return '';

        // Remove numbers and special characters (same logic as product-card)
        let cleanedTitle = title;

        // Remove numbers
        cleanedTitle = cleanedTitle
          .replace(/0/g, '')
          .replace(/1/g, '')
          .replace(/2/g, '')
          .replace(/3/g, '')
          .replace(/4/g, '')
          .replace(/5/g, '')
          .replace(/6/g, '')
          .replace(/7/g, '')
          .replace(/8/g, '')
          .replace(/9/g, '');

        // Remove special characters
        cleanedTitle = cleanedTitle
          .replace(/!/g, '')
          .replace(/@/g, '')
          .replace(/#/g, '')
          .replace(/\$/g, '')
          .replace(/%/g, '')
          .replace(/\^/g, '')
          .replace(/&/g, '')
          .replace(/\*/g, '')
          .replace(/\(/g, '')
          .replace(/\)/g, '')
          .replace(/_/g, '')
          .replace(/\+/g, '')
          .replace(/=/g, '')
          .replace(/-/g, '')
          .replace(/\[/g, '')
          .replace(/\]/g, '')
          .replace(/\{/g, '')
          .replace(/\}/g, '')
          .replace(/;/g, '')
          .replace(/:/g, '')
          .replace(/,/g, '')
          .replace(/\./g, '')
          .replace(/</g, '')
          .replace(/>/g, '')
          .replace(/\?/g, '')
          .replace(/~/g, '')
          .replace(/'/g, '')
          .replace(/"/g, '')
          .replace(/\\/g, '')
          .replace(/\//g, '');

        return cleanedTitle.trim();
      },

      initializeCarousels() {
        // All carousels are now handled by the generic-carousel snippet
        // No custom initialization needed
      },
    };
  }
</script>

<style>
  /* Hide scrollbars for all drawers */
  .scrollbar-hide {
    -ms-overflow-style: none; /* Internet Explorer 10+ */
    scrollbar-width: none; /* Firefox */
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none; /* Safari and Chrome */
  }

  /* Tags carousel now uses standard carousel behavior */
  .search-tags-carousel .swiper-slide {
    height: auto;
  }
</style>

{% schema %}
{
  "name": "Search Drawer",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "General Settings"
    },
    {
      "type": "text",
      "id": "search_title",
      "label": "Search Title",
      "default": "Search"
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Search Placeholder",
      "default": "Search products, categories..."
    },
    {
      "type": "range",
      "id": "drawer_width",
      "min": 300,
      "max": 600,
      "step": 20,
      "unit": "px",
      "label": "Drawer Width (Desktop)",
      "default": 420
    },
    {
      "type": "header",
      "content": "Search History"
    },
    {
      "type": "text",
      "id": "history_title",
      "label": "History Section Title",
      "default": "Recent Searches"
    },
    {
      "type": "text",
      "id": "clear_text",
      "label": "Clear Button Text",
      "default": "Clear"
    },
    {
      "type": "text",
      "id": "clear_all_text",
      "label": "Clear All Button Text",
      "default": "Clear all"
    },
    {
      "type": "header",
      "content": "Security Icons Section"
    },
    {
      "type": "checkbox",
      "id": "show_security_icons",
      "label": "Show Security Icons",
      "default": true
    },
    {
      "type": "header",
      "content": "Security Icon 1"
    },
    {
      "type": "checkbox",
      "id": "show_security_icon_1",
      "label": "Show Icon 1",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "security_icon_1",
      "label": "Icon Image 1"
    },
    {
      "type": "text",
      "id": "security_title_1",
      "label": "Title 1",
      "default": "Pago Seguro"
    },
    {
      "type": "text",
      "id": "security_description_1",
      "label": "Description 1",
      "default": "100% Protegido"
    },
    {
      "type": "header",
      "content": "Security Icon 2"
    },
    {
      "type": "checkbox",
      "id": "show_security_icon_2",
      "label": "Show Icon 2",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "security_icon_2",
      "label": "Icon Image 2"
    },
    {
      "type": "text",
      "id": "security_title_2",
      "label": "Title 2",
      "default": "Envío Gratis"
    },
    {
      "type": "text",
      "id": "security_description_2",
      "label": "Description 2",
      "default": "En pedidos +$500k"
    },
    {
      "type": "header",
      "content": "Security Icon 3"
    },
    {
      "type": "checkbox",
      "id": "show_security_icon_3",
      "label": "Show Icon 3",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "security_icon_3",
      "label": "Icon Image 3"
    },
    {
      "type": "text",
      "id": "security_title_3",
      "label": "Title 3",
      "default": "Garantía"
    },
    {
      "type": "text",
      "id": "security_description_3",
      "label": "Description 3",
      "default": "30 días"
    },
    {
      "type": "header",
      "content": "CTA Section"
    },
    {
      "type": "checkbox",
      "id": "show_cta_section",
      "label": "Show CTA Section",
      "default": true
    },
    {
      "type": "text",
      "id": "cta_title",
      "label": "CTA Title",
      "default": "¿Necesitas ayuda?"
    },
    {
      "type": "textarea",
      "id": "cta_description",
      "label": "CTA Description",
      "default": "Nuestro equipo está listo para ayudarte con cualquier pregunta."
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "Button Text",
      "default": "Contáctanos"
    },
    {
      "type": "url",
      "id": "cta_button_link",
      "label": "Button Link"
    },
    {
      "type": "header",
      "content": "Product Carousel"
    },
    {
      "type": "checkbox",
      "id": "show_product_carousel",
      "label": "Show Product Carousel",
      "default": true
    },
    {
      "type": "text",
      "id": "product_carousel_title",
      "label": "Product Carousel Title",
      "default": "Featured Products"
    },
    {
      "type": "select",
      "id": "product_source",
      "label": "Product Source",
      "options": [
        {
          "value": "collection",
          "label": "Collection"
        },
        {
          "value": "tags",
          "label": "Product Tags"
        },
        {
          "value": "manual",
          "label": "Manual Selection"
        }
      ],
      "default": "collection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select products from this collection"
    },
    {
      "type": "text",
      "id": "product_tags",
      "label": "Product Tags",
      "info": "Comma-separated tags (e.g., 'best-seller,new')"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Manual Product Selection"
    },
    {
      "type": "range",
      "id": "max_products",
      "min": 4,
      "max": 20,
      "step": 1,
      "label": "Maximum Products in Carousel",
      "default": 8
    },
    {
      "type": "header",
      "content": "Search Results"
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View All Button Text",
      "default": "Ver todos"
    },
    {
      "type": "text",
      "id": "results_title",
      "label": "Results Title",
      "default": "Productos encontrados"
    },
    {
      "type": "text",
      "id": "results_text",
      "label": "Results Text",
      "default": "resultados"
    },
    {
      "type": "text",
      "id": "matching_categories_title",
      "label": "Matching Categories Title",
      "default": "Categorías que coinciden"
    },
    {
      "type": "text",
      "id": "new_badge_text",
      "label": "New Badge Text",
      "default": "Nuevo"
    },
    {
      "type": "header",
      "content": "No Results"
    },
    {
      "type": "text",
      "id": "no_results_title",
      "label": "No Results Title",
      "default": "No results found"
    },
    {
      "type": "text",
      "id": "no_results_text",
      "label": "No Results Text",
      "default": "Try searching with different keywords"
    },
    {
      "type": "text",
      "id": "searching_text",
      "label": "Searching Text",
      "default": "Searching..."
    }
  ],
  "presets": [
    {
      "name": "Search Drawer",
      "settings": {
        "search_title": "Buscar",
        "search_placeholder": "Busca productos, categorías...",
        "drawer_width": 420,
        "show_security_icons": true,
        "show_security_icon_1": true,
        "show_security_icon_2": true,
        "show_security_icon_3": true,
        "show_cta_section": true,
        "show_product_carousel": true,
        "product_carousel_title": "Productos Destacados",
        "product_source": "collection",
        "max_products": 8
      }
    }
  ]
}
{% endschema %}
